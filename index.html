<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CodeCrystal IDE</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/ruby/ruby.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/go/go.min.js"></script>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">
  
  <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%238b5cf6%22><path d=%22M16 18l6-6-6-6M8 6l-6 6 6 6%22/></svg>">
  
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
    
    .cm-keyword {
      color: #ff9d00 !important;
      text-shadow: 0 0 8px rgba(255, 157, 0, 0.6) !important;
      font-weight: bold !important;
    }
    
    .cm-def, .cm-variable-2, .cm-property {
      color: #c792ea !important;
      text-shadow: 0 0 8px rgba(199, 146, 234, 0.6) !important;
    }
    
    .cm-string {
      color: #7ec699 !important;
      text-shadow: 0 0 8px rgba(126, 198, 153, 0.6) !important;
    }
    
    .cm-number {
      color: #7fcef5 !important;
      text-shadow: 0 0 8px rgba(127, 206, 245, 0.6) !important;
    }
    
    .cm-comment {
      color: #676e95 !important;
      font-style: italic !important;
    }
    
    .cm-variable {
      color: #e06c75 !important;
      text-shadow: 0 0 8px rgba(224, 108, 117, 0.6) !important;
    }
    
    .cm-operator {
      color: #f9f9f9 !important;
      text-shadow: 0 0 8px rgba(249, 249, 249, 0.6) !important;
    }
    
    .cm-tag {
      color: #ff5370 !important;
      text-shadow: 0 0 8px rgba(255, 83, 112, 0.6) !important;
    }
    
    .cm-attribute {
      color: #ffcb6b !important;
      text-shadow: 0 0 8px rgba(255, 203, 107, 0.6) !important;
    }
    
    .CodeMirror {
      height: 100% !important;
      font-family: monospace !important;
      font-size: 14px !important;
      line-height: 1.6 !important;
    }
    
    .CodeMirror-gutters {
      background-color: rgba(0, 0, 0, 0.3) !important;
      border-right: none !important;
    }
    
    .CodeMirror-linenumber {
      color: #909090 !important;
    }
    
    .terminal {
      background-color: #1a1a1a;
      color: #f0f0f0;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      padding: 10px;
      overflow-y: auto;
      white-space: pre-wrap;
      height: 100%;
    }
    
    .terminal-error {
      color: #ff6b6b;
    }
    
    .terminal-success {
      color: #6bff6b;
    }
    
    .terminal-warning {
      color: #ffde6b;
    }
    
    .terminal-line {
      margin: 0;
      padding: 2px 0;
    }
    
    .file-badge {
      width: 12px;
      height: 12px;
      border-radius: 6px;
      display: inline-block;
      margin-right: 8px;
    }
    
    .unsaved-indicator {
      width: 8px;
      height: 8px;
      border-radius: 4px;
      background-color: #f87171;
      display: inline-block;
      margin-left: 6px;
    }
    
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 20px;
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      border-radius: 4px;
      z-index: 1000;
      transition: opacity 0.5s ease;
    }
    
    .language-badge {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 4px 12px;
      border-radius: 16px;
      margin-right: 8px;
      cursor: pointer;
      font-size: 0.875rem;
      min-width: 80px;
      text-align: center;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .language-badge:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }
    
    .tab {
      display: flex;
      align-items: center;
      padding: 8px 16px;
      padding-right: 8px;
      cursor: pointer;
      border-right: 1px solid #2d3748;
      position: relative;
      overflow: hidden;
      min-width: 120px;
      max-width: 200px;
    }
    
    .tab.active {
      background-color: #2d3748;
    }
    
    .tab-name-container {
      flex-grow: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .tab-actions {
      display: flex;
      margin-left: 4px;
      opacity: 0.7;
    }
    
    .tab:hover .tab-actions {
      opacity: 1;
    }
    
    .tab-action-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      border-radius: 4px;
      margin-left: 2px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
    }
    
    .tab-action-btn:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .sidebar-button {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
      border-radius: 8px;
      color: #cccccc;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .sidebar-button:hover {
      background-color: rgba(255, 255, 255, 0.1);
      transform: translateY(-1px);
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-200">
  <div id="editor-container" class="flex flex-col h-screen">
    <div class="flex items-center justify-between p-2 border-b border-gray-700">
      <div class="flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-2 text-purple-500" viewBox="0 0 24 24" fill="none" 
           stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="16 18 22 12 16 6"></polyline>
          <polyline points="8 6 2 12 8 18"></polyline>
        </svg>
        <span class="font-bold text-lg">CodeCrystal IDE</span>
        <span id="file-counter" class="text-xs ml-4 text-gray-400">No files open</span>
      </div>
      <div class="flex space-x-3">
        <div class="relative group">
          <button id="new-file-btn" class="p-1 rounded hover:bg-gray-700" title="New File (Ctrl+N)">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-400" viewBox="0 0 24 24" fill="none" 
               stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="12" y1="18" x2="12" y2="12"></line>
              <line x1="9" y1="15" x2="15" y2="15"></line>
            </svg>
          </button>
          <div id="new-file-dropdown" class="absolute hidden bg-gray-800 border border-gray-700 rounded shadow-lg p-2 z-10 right-0 mt-1">
            <div class="text-xs font-bold mb-1 text-gray-400">New file as:</div>
            <div id="language-options"></div>
          </div>
        </div>
        <button id="open-file-btn" class="p-1 rounded hover:bg-gray-700" title="Open File (Ctrl+O)">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-400" viewBox="0 0 24 24" fill="none" 
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M5 8V5a2 2 0 0 1 2-2h7.5L19 7.5V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8Z"></path>
            <path d="M12 18v-6"></path>
            <path d="m9 15 3-3 3 3"></path>
          </svg>
        </button>
        <button id="save-file-btn" class="p-1 rounded hover:bg-gray-700" title="Save File (Ctrl+S)">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-400" viewBox="0 0 24 24" fill="none" 
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
            <polyline points="17 21 17 13 7 13 7 21"></polyline>
            <polyline points="7 3 7 8 15 8"></polyline>
          </svg>
        </button>
        <button id="settings-btn" class="p-1 rounded hover:bg-gray-700" title="Settings">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-400" viewBox="0 0 24 24" fill="none" 
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>
        </button>
      </div>
    </div>

    <div class="flex flex-1 overflow-hidden">
      <div class="w-16 bg-gray-800 flex flex-col items-center py-4 border-r border-gray-700">
        <button id="open-folder-btn" class="sidebar-button" title="Open Folder">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-blue-400" viewBox="0 0 24 24" fill="none" 
               stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"></path>
          </svg>
        </button>
        <button id="rename-file-btn" class="sidebar-button" title="Rename Current File">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-green-400" viewBox="0 0 24 24" fill="none" 
               stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 20h9"></path>
            <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
          </svg>
        </button>
        <button id="preview-toggle-btn" class="sidebar-button" title="Toggle Preview">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-gray-400" viewBox="0 0 24 24" fill="none" 
               stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>
        </button>
        <button id="terminal-toggle-btn" class="sidebar-button" title="Toggle Terminal">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-gray-400" viewBox="0 0 24 24" fill="none" 
               stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="4 17 10 11 4 5"></polyline>
            <line x1="12" y1="19" x2="20" y2="19"></line>
          </svg>
        </button>
        <button id="run-code-sidebar-btn" class="sidebar-button" title="Run Code (F5)">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-green-400" viewBox="0 0 24 24" fill="none" 
               stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="5 3 19 12 5 21 5 3"></polygon>
          </svg>
        </button>
        <button id="download-project-btn" class="sidebar-button" title="Download Project">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-purple-400" viewBox="0 0 24 24" fill="none" 
               stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
        </button>
      </div>

      <div class="flex-1 flex flex-col overflow-hidden">

        <div id="tabs-container" class="flex border-b border-gray-700 overflow-x-auto"></div>

        <div id="language-bar" class="flex items-center p-2 bg-gray-800">
          <span class="mr-2 text-sm">Language:</span>
          <div id="language-selector" class="flex space-x-2 overflow-x-auto"></div>

          <div id="link-css-container" class="ml-auto hidden">
            <button id="link-css-btn" class="px-2 py-1 bg-purple-600 text-white rounded text-xs flex items-center">
              Link CSS File
            </button>
            <span id="linked-css-info" class="ml-2 text-xs hidden"></span>
          </div>
        </div>
        
        <div id="editor-preview-container" class="flex-1 flex overflow-hidden">
          <div id="editor-area" class="relative w-full">
            <div id="code-editor"></div>
          </div>
          
          <div id="preview-panel" class="hidden w-1/2 border-l border-gray-700 flex flex-col">
            <div class="p-2 bg-gray-800 flex justify-between items-center">
              <span class="text-sm font-medium">Live Preview</span>
              <button id="refresh-preview-btn" class="px-2 py-1 bg-green-600 text-white rounded text-xs">
                Refresh
              </button>
            </div>
            <div class="flex-1 bg-white overflow-auto">
              <iframe id="preview-iframe" style="width: 100%; height: 100%; border: none;" title="Preview"></iframe>
            </div>
          </div>
          
          <div id="terminal-panel" class="hidden w-1/2 border-l border-gray-700 flex flex-col">
            <div class="p-2 bg-gray-800 flex justify-between items-center">
              <span class="text-sm font-medium">Terminal</span>
              <div class="flex space-x-2">
                <button id="clear-terminal-btn" class="px-2 py-1 bg-gray-600 text-white rounded text-xs">
                  Clear
                </button>
                <button id="run-code-btn" class="px-2 py-1 bg-green-600 text-white rounded text-xs flex items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" 
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1">
                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                  </svg>
                  Run
                </button>
              </div>
            </div>
            <div id="terminal" class="terminal flex-1 overflow-auto">
              <div class="terminal-line">Welcome to CodeCrystal Terminal. Press Run to execute your code.</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="flex justify-between items-center px-4 py-1 text-sm bg-gray-800 text-gray-400">
      <div>
        <span id="cursor-position" class="mr-4">Line: 1, Col: 1</span>
        <span>Spaces: 2</span>
      </div>
      <div>
        <span id="language-indicator" class="px-2 py-1 rounded"></span>
      </div>
    </div>
  </div>
  
  <div id="toast" class="toast hidden"></div>
  
  <div id="settings-modal" class="fixed inset-0 flex items-center justify-center hidden z-50">
    <div class="fixed inset-0 bg-black opacity-50" id="settings-backdrop"></div>
    <div class="bg-gray-800 rounded-lg shadow-lg w-11/12 md:w-3/4 lg:w-1/2 max-h-[80vh] overflow-y-auto relative z-10">
      <div class="flex justify-between items-center p-4 border-b border-gray-700">
        <h2 class="text-xl font-bold">CodeCrystal Settings</h2>
        <button id="close-settings-btn" class="text-gray-400 hover:text-white">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      
      <div class="p-4">
        <div class="flex border-b border-gray-700 mb-4">
          <button class="settings-tab-btn px-4 py-2 text-blue-400 border-b-2 border-blue-400" data-tab="theme">Theme</button>
          <button class="settings-tab-btn px-4 py-2 text-gray-400" data-tab="editor">Editor</button>
          <button class="settings-tab-btn px-4 py-2 text-gray-400" data-tab="colors">Syntax Colors</button>
        </div>
        
        <div class="settings-tab-content" id="theme-settings">
          <div class="mb-4">
            <h3 class="text-lg font-medium mb-2">Editor Theme</h3>
            <div class="flex space-x-2">
              <button class="theme-option px-4 py-2 rounded bg-gray-700 text-white" data-theme="dark">Dark</button>
              <button class="theme-option px-4 py-2 rounded bg-gray-400 text-gray-800" data-theme="light">Light</button>
              <button class="theme-option px-4 py-2 rounded bg-purple-900 text-white" data-theme="cosmic">Cosmic</button>
              <button class="theme-option px-4 py-2 rounded bg-blue-900 text-white" data-theme="ocean">Ocean</button>
            </div>
          </div>
          
          <div class="mb-4">
            <h3 class="text-lg font-medium mb-2">Accent Color</h3>
            <div class="flex items-center space-x-3">
              <input type="color" id="accent-color-picker" value="#8b5cf6" class="w-12 h-12 rounded cursor-pointer">
              <span class="text-sm text-gray-400">This color will be used for UI highlights</span>
            </div>
          </div>
        </div>
        
        <div class="settings-tab-content hidden" id="editor-settings">
          <div class="mb-4">
            <h3 class="text-lg font-medium mb-2">Font Size</h3>
            <div class="flex items-center">
              <input type="range" id="font-size-slider" min="10" max="24" value="14" class="w-full mr-3">
              <span id="font-size-value" class="text-gray-300 w-10">14px</span>
            </div>
          </div>
          
          <div class="mb-4">
            <h3 class="text-lg font-medium mb-2">Tab Size</h3>
            <div class="flex space-x-2">
              <button class="tab-size-btn px-3 py-1 rounded bg-gray-700" data-size="2">2 spaces</button>
              <button class="tab-size-btn px-3 py-1 rounded bg-gray-700" data-size="4">4 spaces</button>
            </div>
          </div>
          
          <div class="mb-4">
            <h3 class="text-lg font-medium mb-2">Other Options</h3>
            <div class="space-y-2">
              <label class="flex items-center">
                <input type="checkbox" id="line-wrap-checkbox" class="mr-2">
                <span>Enable line wrapping</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" id="line-numbers-checkbox" checked class="mr-2">
                <span>Show line numbers</span>
              </label>
            </div>
          </div>
        </div>
        
        <div class="settings-tab-content hidden" id="colors-settings">
          <div class="mb-4">
            <h3 class="text-lg font-medium mb-2">Syntax Highlighting</h3>
            <p class="text-sm text-gray-400 mb-4">Customize the syntax highlighting colors for all languages</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="syntax-color-item">
                <div class="flex justify-between items-center mb-1">
                  <label>Keywords</label>
                  <input type="color" class="syntax-color-picker" data-element="keyword" value="#ff9d00">
                </div>
                <div class="p-2 rounded bg-gray-900">
                  <code class="keyword-example">function</code> <code>return</code> <code>if</code>
                </div>
              </div>
              
              <div class="syntax-color-item">
                <div class="flex justify-between items-center mb-1">
                  <label>Strings</label>
                  <input type="color" class="syntax-color-picker" data-element="string" value="#7ec699">
                </div>
                <div class="p-2 rounded bg-gray-900">
                  <code class="string-example">"Hello, world!"</code>
                </div>
              </div>
              
              <div class="syntax-color-item">
                <div class="flex justify-between items-center mb-1">
                  <label>Variables</label>
                  <input type="color" class="syntax-color-picker" data-element="variable" value="#e06c75">
                </div>
                <div class="p-2 rounded bg-gray-900">
                  <code class="variable-example">myVariable</code>
                </div>
              </div>
              
              <div class="syntax-color-item">
                <div class="flex justify-between items-center mb-1">
                  <label>Numbers</label>
                  <input type="color" class="syntax-color-picker" data-element="number" value="#7fcef5">
                </div>
                <div class="p-2 rounded bg-gray-900">
                  <code class="number-example">42</code> <code>3.14</code>
                </div>
              </div>
              
              <div class="syntax-color-item">
                <div class="flex justify-between items-center mb-1">
                  <label>Comments</label>
                  <input type="color" class="syntax-color-picker" data-element="comment" value="#676e95">
                </div>
                <div class="p-2 rounded bg-gray-900">
                  <code class="comment-example">// This is a comment</code>
                </div>
              </div>
              
              <div class="syntax-color-item">
                <div class="flex justify-between items-center mb-1">
                  <label>Functions</label>
                  <input type="color" class="syntax-color-picker" data-element="def" value="#c792ea">
                </div>
                <div class="p-2 rounded bg-gray-900">
                  <code class="function-example">myFunction()</code>
                </div>
              </div>
            </div>
            
            <div class="mt-4">
              <button id="reset-colors-btn" class="px-3 py-1 bg-red-600 text-white rounded">Reset to Defaults</button>
            </div>
          </div>
        </div>
      </div>
      
      <div class="flex justify-end p-4 border-t border-gray-700">
        <button id="save-settings-btn" class="px-4 py-2 bg-blue-600 text-white rounded">Save Settings</button>
      </div>
    </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      let tabs = [];
      let activeTab = null;
      let showPreview = false;
      let showTerminal = false;
      let theme = 'dark';
      let linkedFiles = {};
      let pyodideInstance = null;
      let pyodideLoading = false;
      let codeEditorInstance = null;
      
      let userSettings = {
        theme: 'dark',
        accentColor: '#8b5cf6',
        fontSize: 14,
        tabSize: 2,
        lineWrap: false,
        lineNumbers: true,
        syntaxColors: {
          keyword: '#ff9d00',
          string: '#7ec699',
          variable: '#e06c75',
          number: '#7fcef5',
          comment: '#676e95',
          def: '#c792ea'
        }
      };
      
      const languages = [
        { id: 'javascript', name: 'JavaScript', color: '#f7df1e', extensions: ['.js', '.jsx', '.ts', '.tsx'], mime: 'text/javascript' },
        { id: 'python', name: 'Python', color: '#3572A5', extensions: ['.py'], mime: 'text/x-python' },
        { id: 'rust', name: 'Rust', color: '#dea584', extensions: ['.rs'], mime: 'text/x-rustsrc' },
        { id: 'go', name: 'Go', color: '#00ADD8', extensions: ['.go'], mime: 'text/x-go' },
        { id: 'html', name: 'HTML', color: '#e34c26', extensions: ['.html', '.htm'], mime: 'text/html' },
        { id: 'css', name: 'CSS', color: '#563d7c', extensions: ['.css'], mime: 'text/css' }
      ];
      
      const tabsContainer = document.getElementById('tabs-container');
      const languageSelector = document.getElementById('language-selector');
      const previewPanel = document.getElementById('preview-panel');
      const previewIframe = document.getElementById('preview-iframe');
      const previewToggleBtn = document.getElementById('preview-toggle-btn');
      const terminalPanel = document.getElementById('terminal-panel');
      const terminal = document.getElementById('terminal');
      const terminalToggleBtn = document.getElementById('terminal-toggle-btn');
      const runCodeBtn = document.getElementById('run-code-btn');
      const runCodeSidebarBtn = document.getElementById('run-code-sidebar-btn');
      const clearTerminalBtn = document.getElementById('clear-terminal-btn');
      const linkCssContainer = document.getElementById('link-css-container');
      const linkedCssInfo = document.getElementById('linked-css-info');
      const linkCssBtn = document.getElementById('link-css-btn');
      const cursorPosition = document.getElementById('cursor-position');
      const languageIndicator = document.getElementById('language-indicator');
      const fileCounter = document.getElementById('file-counter');
      const toast = document.getElementById('toast');
      const newFileBtn = document.getElementById('new-file-btn');
      const newFileDropdown = document.getElementById('new-file-dropdown');
      const languageOptions = document.getElementById('language-options');
      const openFileBtn = document.getElementById('open-file-btn');
      const saveFileBtn = document.getElementById('save-file-btn');
      const openFolderBtn = document.getElementById('open-folder-btn');
      const renameFileBtn = document.getElementById('rename-file-btn');
      const downloadProjectBtn = document.getElementById('download-project-btn');
      const refreshPreviewBtn = document.getElementById('refresh-preview-btn');
      const themeToggleBtn = document.getElementById('theme-toggle-btn');
      const editorArea = document.getElementById('editor-area');
      
      window.writeToTerminalFromPython = function(text) {
        writeToTerminal(text);
      };
      
      function showToast(message) {
        if (!toast) return;
        
        toast.textContent = message;
        toast.classList.remove('hidden');
        
        setTimeout(() => {
          toast.classList.add('hidden');
        }, 3000);
      }
      
      function getFileExtensionForLanguage(language) {
        switch(language) {
          case 'javascript': return '.js';
          case 'python': return '.py';
          case 'rust': return '.rs';
          case 'go': return '.go';
          case 'html': return '.html';
          case 'css': return '.css';
          default: return '.txt';
        }
      }
      
      function getTemplateForLanguage(language) {
        switch(language) {
          case 'html':
            return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  
</body>
</html>`;
          case 'css':
            return `body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 20px;
}
`;
          case 'javascript':
            return `console.log('Hello, world!');

function init() {
}
`;
          case 'python':
            return `def main():
    print("Hello, world!")
    
    numbers = [1, 2, 3, 4, 5]
    squared = [n**2 for n in numbers]
    print(f"Original numbers: {numbers}")
    print(f"Squared numbers: {squared}")
    
    message = "Python in the browser!"
    print(f"Message: {message}")
    print(f"Uppercase: {message.upper()}")
    print(f"Character count: {len(message)}")

main()
`;
          case 'rust':
            return `fn main() {
    println!("Hello, world!");
}
`;
          case 'go':
            return `package main

import "fmt"

func main() {
    fmt.Println("Hello, world!")
}
`;
          default:
            return '';
        }
      }
      
      function getLanguageColor(language) {
        return languages.find(l => l.id === language)?.color || '#ffffff';
      }
      
      function handleEditorInput() {
        const tab = tabs.find(t => t.id === activeTab);
        if (!tab) return;
        
        tab.content = codeEditorInstance.getValue();
        tab.isUnsaved = true;
        renderTabs();
        
        if (showPreview && (tab.language === 'html' || tab.language === 'css')) {
          updatePreview();
        }
      }
      
      function renderTabs() {
        if (!tabsContainer) return;
        
        tabsContainer.innerHTML = '';
        
        tabs.forEach(tab => {
          const tabElement = document.createElement('div');
          tabElement.className = `tab ${tab.id === activeTab ? 'active' : ''}`;
          
          const badge = document.createElement('div');
          badge.className = 'file-badge';
          badge.style.backgroundColor = getLanguageColor(tab.language);
          tabElement.appendChild(badge);
          
          const nameContainer = document.createElement('div');
          nameContainer.className = 'tab-name-container';
          nameContainer.title = tab.path ? `${tab.path}/${tab.name}` : tab.name;
          
          if (tab.path) {
            const pathSpan = document.createElement('span');
            pathSpan.className = 'text-xs text-gray-500 mr-1';
            pathSpan.textContent = tab.path + '/';
            nameContainer.appendChild(pathSpan);
          }
          
          const nameSpan = document.createElement('span');
          nameSpan.textContent = tab.displayName || tab.name;
          nameContainer.appendChild(nameSpan);
          
          if (tab.isUnsaved) {
            const unsavedDot = document.createElement('div');
            unsavedDot.className = 'unsaved-indicator ml-2';
            nameContainer.appendChild(unsavedDot);
          }
          
          tabElement.appendChild(nameContainer);
          
          const actions = document.createElement('div');
          actions.className = 'tab-actions';
          
          const renameBtn = document.createElement('button');
          renameBtn.className = 'tab-action-btn';
          renameBtn.innerHTML = '✎';
          renameBtn.title = 'Rename';
          renameBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            renameFile(tab.id);
          });
          
          const closeBtn = document.createElement('button');
          closeBtn.className = 'tab-action-btn';
          closeBtn.innerHTML = '×';
          closeBtn.title = 'Close';
          closeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            closeTab(tab.id);
          });
          
          actions.appendChild(renameBtn);
          actions.appendChild(closeBtn);
          tabElement.appendChild(actions);
          
          tabElement.addEventListener('click', () => setActiveTab(tab.id));
          
          tabsContainer.appendChild(tabElement);
        });
        
        if (fileCounter) {
          fileCounter.textContent = tabs.length > 0 ? `${tabs.length} files open` : 'No files open';
        }
      }
      
      function setActiveTab(id) {
        const tab = tabs.find(t => t.id === id);
        if (!tab) return;
        
        activeTab = id;
        
        if (codeEditorInstance) {
          codeEditorInstance.setValue(tab.content);
          
          const langInfo = languages.find(l => l.id === tab.language);
          if (langInfo) {
            codeEditorInstance.setOption('mode', langInfo.mime);
          }
        }
        
        updateLanguageUI(tab.language);
        renderTabs();
        
        if (tab.language === 'html' && linkCssContainer) {
          linkCssContainer.classList.remove('hidden');
          updateLinkedCssInfo();
        } else if (linkCssContainer) {
          linkCssContainer.classList.add('hidden');
        }
        
        if (showPreview && (tab.language === 'html' || tab.language === 'css')) {
          updatePreview(true);
        } else if (showPreview && previewPanel && editorArea) {
          previewPanel.classList.add('hidden');
          editorArea.classList.remove('w-1/2');
          editorArea.classList.add('w-full');
        }
      }
      
      function updateLanguageUI(language) {
        if (!languageSelector || !languageIndicator) return;
        
        const allBadges = languageSelector.querySelectorAll('.language-badge');
        allBadges.forEach(badge => {
          if (badge.dataset.language === language) {
            badge.style.boxShadow = `0 0 8px ${getLanguageColor(language)}`;
            badge.style.fontWeight = 'bold';
          } else {
            badge.style.boxShadow = 'none';
            badge.style.fontWeight = 'normal';
          }
        });
        
        const color = getLanguageColor(language);
        languageIndicator.style.backgroundColor = color;
        languageIndicator.style.color = 'black';
        languageIndicator.style.boxShadow = `0 0 5px ${color}`;
        languageIndicator.textContent = languages.find(l => l.id === language)?.name || 'Unknown';
      }
      
      function createNewTab(language) {
        const id = Date.now();
        const extension = getFileExtensionForLanguage(language);
        const content = getTemplateForLanguage(language);
        
        const tab = {
          id: id,
          name: `untitled${extension}`,
          displayName: `untitled${extension}`,
          language: language,
          content: content,
          isUnsaved: true,
          fileHandle: null
        };
        
        tabs.push(tab);
        renderTabs();
        setActiveTab(id);
        showToast(`Created new ${languages.find(l => l.id === language).name} file`);
      }
      
      initEditor();
      
      function initEditor() {
        if (!languageSelector) {
          console.error("Language selector not found");
          return;
        }
        
        codeEditorInstance = CodeMirror(document.getElementById('code-editor'), {
          lineNumbers: true,
          theme: 'dracula',
          mode: 'javascript',
          indentUnit: 2,
          tabSize: 2,
          lineWrapping: false,
          autoCloseBrackets: true,
          matchBrackets: true,
          styleActiveLine: true,
          extraKeys: {
            "Tab": function(cm) {
              cm.replaceSelection("  ", "end");
            }
          }
        });
        
        codeEditorInstance.setSize("100%", "100%");
        
        codeEditorInstance.on("cursorActivity", function() {
          const cursor = codeEditorInstance.getCursor();
          if (cursorPosition) {
            cursorPosition.textContent = `Line: ${cursor.line + 1}, Col: ${cursor.ch + 1}`;
          }
        });
        
        codeEditorInstance.on("change", function() {
          handleEditorInput();
        });
        
        languages.forEach(lang => {
          const langBtn = document.createElement('div');
          langBtn.className = 'language-badge';
          langBtn.style.backgroundColor = lang.color;
          langBtn.style.color = 'black';
          langBtn.textContent = lang.name;
          langBtn.dataset.language = lang.id;
          languageSelector.appendChild(langBtn);
          
          if (languageOptions) {
            const option = document.createElement('div');
            option.className = 'px-3 py-1 hover:bg-gray-700 cursor-pointer rounded text-sm flex items-center';
            option.dataset.language = lang.id;
            
            const colorDot = document.createElement('div');
            colorDot.className = 'w-2 h-2 rounded-full mr-2';
            colorDot.style.backgroundColor = lang.color;
            
            option.appendChild(colorDot);
            option.appendChild(document.createTextNode(lang.name));
            languageOptions.appendChild(option);
          }
        });
        
        loadSettings();
        
        createNewTab('javascript');
        
        setupEventListeners();
      }
      
      function loadSettings() {
        let settings = null;
        const savedLocal = localStorage.getItem('codecrystal-settings');
        
        if (savedLocal) {
          try {
            settings = JSON.parse(savedLocal);
          } catch (e) {
            console.error('Error loading settings from localStorage:', e);
          }
        }
        
        if (!settings) {
          const cookieData = getCookie('codecrystal-settings');
          if (cookieData) {
            settings = cookieData;
          }
        }
        
        if (settings) {
          userSettings = { ...userSettings, ...settings };
        }
        
        applySettings();
      }
      
      function setupEventListeners() {
        if (newFileBtn) newFileBtn.addEventListener('click', toggleNewFileDropdown);
        if (openFileBtn) openFileBtn.addEventListener('click', openFile);
        if (saveFileBtn) saveFileBtn.addEventListener('click', saveFile);
        if (openFolderBtn) openFolderBtn.addEventListener('click', openFolder);
        if (renameFileBtn) renameFileBtn.addEventListener('click', () => renameFile(activeTab));
        if (downloadProjectBtn) downloadProjectBtn.addEventListener('click', downloadProject);
        if (refreshPreviewBtn) refreshPreviewBtn.addEventListener('click', () => updatePreview(true));
        if (themeToggleBtn) themeToggleBtn.addEventListener('click', toggleTheme);
        if (previewToggleBtn) previewToggleBtn.addEventListener('click', togglePreview);
        if (terminalToggleBtn) terminalToggleBtn.addEventListener('click', toggleTerminal);
        if (linkCssBtn) linkCssBtn.addEventListener('click', linkCssFile);
        if (runCodeBtn) runCodeBtn.addEventListener('click', runCode);
        if (runCodeSidebarBtn) runCodeSidebarBtn.addEventListener('click', runCode);
        if (clearTerminalBtn) clearTerminalBtn.addEventListener('click', clearTerminal);
        
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const settingsTabBtns = document.querySelectorAll('.settings-tab-btn');
        const resetColorsBtn = document.getElementById('reset-colors-btn');
        
        if (settingsBtn) {
          settingsBtn.addEventListener('click', function() {
            if (settingsModal) {
              settingsModal.classList.remove('hidden');
              loadSettingsToForm();
            }
          });
        }
        
        if (closeSettingsBtn) {
          closeSettingsBtn.addEventListener('click', function() {
            if (settingsModal) settingsModal.classList.add('hidden');
          });
        }
        
        if (settingsModal) {
          const settingsBackdrop = document.getElementById('settings-backdrop');
          if (settingsBackdrop) {
            settingsBackdrop.addEventListener('click', function() {
              settingsModal.classList.add('hidden');
            });
          }
        }
        
        if (settingsTabBtns) {
          settingsTabBtns.forEach(btn => {
            btn.addEventListener('click', function() {
              const tabName = btn.dataset.tab;
              
              settingsTabBtns.forEach(b => {
                b.classList.remove('text-blue-400', 'border-b-2', 'border-blue-400');
                b.classList.add('text-gray-400');
              });
              btn.classList.remove('text-gray-400');
              btn.classList.add('text-blue-400', 'border-b-2', 'border-blue-400');
              
              document.querySelectorAll('.settings-tab-content').forEach(content => {
                content.classList.add('hidden');
              });
              document.getElementById(`${tabName}-settings`).classList.remove('hidden');
            });
          });
        }
        
        document.querySelectorAll('.theme-option').forEach(btn => {
          btn.addEventListener('click', function() {
            document.querySelectorAll('.theme-option').forEach(b => {
              b.classList.remove('ring-2', 'ring-blue-500');
            });
            btn.classList.add('ring-2', 'ring-blue-500');
          });
        });
        
        const fontSizeSlider = document.getElementById('font-size-slider');
        const fontSizeValue = document.getElementById('font-size-value');
        if (fontSizeSlider && fontSizeValue) {
          fontSizeSlider.addEventListener('input', function() {
            fontSizeValue.textContent = `${fontSizeSlider.value}px`;
          });
        }
        
        document.querySelectorAll('.tab-size-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            document.querySelectorAll('.tab-size-btn').forEach(b => {
              b.classList.remove('bg-blue-600');
            });
            btn.classList.add('bg-blue-600');
          });
        });
        
        if (resetColorsBtn) {
          resetColorsBtn.addEventListener('click', function() {
            const defaultColors = {
              keyword: '#ff9d00',
              string: '#7ec699',
              variable: '#e06c75',
              number: '#7fcef5',
              comment: '#676e95',
              def: '#c792ea'
            };
            
            document.querySelectorAll('.syntax-color-picker').forEach(picker => {
              const element = picker.dataset.element;
              if (defaultColors[element]) {
                picker.value = defaultColors[element];
              }
            });
          });
        }
        
        if (saveSettingsBtn) {
          saveSettingsBtn.addEventListener('click', function() {
            saveSettingsFromForm();
            applySettings();
            if (settingsModal) settingsModal.classList.add('hidden');
            showToast('Settings saved successfully');
          });
        }
        
        if (languageSelector) {
          languageSelector.addEventListener('click', function(e) {
            const langBtn = e.target.closest('.language-badge');
            if (langBtn) {
              const language = langBtn.dataset.language;
              if (language) {
                changeLanguage(language);
              }
            }
          });
        }
        
        if (languageOptions) {
          languageOptions.addEventListener('click', function(e) {
            const option = e.target.closest('[data-language]');
            if (option) {
              const language = option.dataset.language;
              if (language) {
                createNewTab(language);
                toggleNewFileDropdown();
              }
            }
          });
        }
        
        document.addEventListener('click', (e) => {
          if (newFileDropdown && !e.target.closest('#new-file-btn') && !e.target.closest('#new-file-dropdown')) {
            newFileDropdown.classList.add('hidden');
          }
        });
        
        document.addEventListener('keydown', (e) => {
          if (e.key === 'F5') {
            e.preventDefault();
            runCode();
          }
          
          if (e.key === 's' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            saveFile();
          }
          
          if (e.key === 'n' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            toggleNewFileDropdown();
          }
          
          if (e.key === 'o' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            openFile();
          }
        });
      }
      
      function toggleNewFileDropdown() {
        if (!newFileDropdown) return;
        
        if (newFileDropdown.classList.contains('hidden')) {
          newFileDropdown.classList.remove('hidden');
        } else {
          newFileDropdown.classList.add('hidden');
        }
      }
      
      function togglePreview() {
        if (!previewPanel || !editorArea) return;
        
        showPreview = !showPreview;
        
        if (showPreview) {
          previewPanel.classList.remove('hidden');
          editorArea.classList.remove('w-full');
          editorArea.classList.add('w-1/2');
          updatePreview(true);
        } else {
          previewPanel.classList.add('hidden');
          editorArea.classList.remove('w-1/2');
          editorArea.classList.add('w-full');
        }
      }
      
      function toggleTerminal() {
        if (!terminalPanel || !editorArea) return;
        
        showTerminal = !showTerminal;
        
        if (showTerminal) {
          terminalPanel.classList.remove('hidden');
          if (showPreview) {
            editorArea.classList.remove('w-1/2', 'w-full');
            editorArea.classList.add('w-1/3');
            previewPanel.classList.remove('w-1/2');
            previewPanel.classList.add('w-1/3');
            terminalPanel.classList.remove('w-1/2');
            terminalPanel.classList.add('w-1/3');
          } else {
            editorArea.classList.remove('w-full');
            editorArea.classList.add('w-1/2');
            terminalPanel.classList.remove('w-1/2');
            terminalPanel.classList.add('w-1/2');
          }
        } else {
          terminalPanel.classList.add('hidden');
          if (showPreview) {
            editorArea.classList.remove('w-1/3', 'w-full');
            editorArea.classList.add('w-1/2');
            previewPanel.classList.remove('w-1/3');
            previewPanel.classList.add('w-1/2');
          } else {
            editorArea.classList.remove('w-1/2', 'w-1/3');
            editorArea.classList.add('w-full');
          }
        }
      }
      
      function changeLanguage(language) {
        const tab = tabs.find(t => t.id === activeTab);
        if (!tab) return;
        
        const oldExtension = tab.name.substring(tab.name.lastIndexOf('.'));
        const newExtension = getFileExtensionForLanguage(language);
        
        if (tab.name.lastIndexOf('.') !== -1) {
          tab.name = tab.name.substring(0, tab.name.lastIndexOf('.')) + newExtension;
          tab.displayName = tab.name;
        }
        
        const currentContent = tab.content;
        let updatedContent = currentContent;
        
        const isBasicComment = 
          currentContent.trim() === '// Start typing your code here...' ||
          currentContent.trim() === '# Start typing your code here...';
          
        if (!currentContent.trim() || isBasicComment) {
          updatedContent = getTemplateForLanguage(language);
        }
        
        tab.language = language;
        tab.content = updatedContent;
        tab.isUnsaved = true;
        
        if (codeEditorInstance) {
          codeEditorInstance.setValue(updatedContent);
          
          const langInfo = languages.find(l => l.id === language);
          if (langInfo) {
            codeEditorInstance.setOption('mode', langInfo.mime);
          }
        }
        
        updateLanguageUI(language);
        renderTabs();
        
        if (tab.language === 'html' && linkCssContainer) {
          linkCssContainer.classList.remove('hidden');
          updateLinkedCssInfo();
        } else if (linkCssContainer) {
          linkCssContainer.classList.add('hidden');
        }
      }
      
      function writeToTerminal(text, className = '') {
        if (!terminal) return;
        
        const line = document.createElement('div');
        line.className = `terminal-line ${className}`;
        line.textContent = text;
        terminal.appendChild(line);
        
        terminal.scrollTop = terminal.scrollHeight;
      }
      
      function clearTerminal() {
        if (!terminal) return;
        
        terminal.innerHTML = '';
        writeToTerminal('Terminal cleared');
      }
      
      async function runCode() {
        const tab = tabs.find(t => t.id === activeTab);
        if (!tab) return;
        
        if (!showTerminal && terminalPanel) {
          toggleTerminal();
        }
        
        clearTerminal();
        
        writeToTerminal(`Running ${tab.name}...`, 'terminal-success');
        
        if (tab.language === 'javascript') {
          try {
            const code = tab.content;
            const consoleMethods = {
              log: (...args) => writeToTerminal(args.join(' ')),
              warn: (...args) => writeToTerminal(args.join(' '), 'terminal-warning'),
              error: (...args) => writeToTerminal(args.join(' '), 'terminal-error'),
              info: (...args) => writeToTerminal(args.join(' '))
            };
            
            const runWithCustomConsole = new Function('console', code);
            
            runWithCustomConsole(consoleMethods);
            
            writeToTerminal('Code executed successfully', 'terminal-success');
        } catch (error) {
            writeToTerminal(`Error: ${error.message}`, 'terminal-error');
          }
        } else if (tab.language === 'python') {
          await runPythonCode(tab.content);
        } else {
          writeToTerminal(`Language '${tab.language}' execution is not supported in the browser.`, 'terminal-warning');
        }
      }
      
      async function runPythonCode(code) {
        writeToTerminal('Initializing Python environment...', 'terminal-warning');
        
        try {
        if (!pyodideInstance) {
            if (pyodideLoading) {
              writeToTerminal('Python environment is still loading, please wait...', 'terminal-warning');
          return;
        }
            
            pyodideLoading = true;
            writeToTerminal('Loading Python (this may take a moment on first run)...', 'terminal-warning');
        
        try {
              pyodideInstance = await loadPyodide();
              writeToTerminal('Python environment loaded successfully!', 'terminal-success');
          
              await pyodideInstance.runPythonAsync(`
            import sys
                from js import writeToTerminalFromPython
                
                class CustomStdout:
                def write(self, text):
                        writeToTerminalFromPython(text)
                def flush(self):
                        pass
                
                sys.stdout = CustomStdout()
                sys.stderr = CustomStdout()
              `);
              
            } catch (err) {
              writeToTerminal(`Failed to load Python: ${err.message}`, 'terminal-error');
              pyodideLoading = false;
              return;
            }
            
            pyodideLoading = false;
          }
          
          writeToTerminal('Running Python code...', 'terminal-success');
          await pyodideInstance.runPythonAsync(code);
          writeToTerminal('Python execution completed', 'terminal-success');
          
        } catch (err) {
          writeToTerminal(`Python Error: ${err.message}`, 'terminal-error');
        }
      }
      
      function updatePreview(force = false) {
        if (!showPreview && !force) return;
        if (!previewPanel || !previewIframe) return;
        
        const tab = tabs.find(t => t.id === activeTab);
        if (!tab) return;
        
        if (tab.language === 'html') {
          const doc = previewIframe.contentDocument || previewIframe.contentWindow.document;
          
          // For preview, embed CSS content directly instead of linking
          // (this prevents 404 errors for CSS files that don't exist as real files)
          let content = tab.content;
          
          // Find all linked CSS files and embed their content
          const linkRegex = /<link[^>]*href=["']([^"']+\.css)["'][^>]*>/g;
          let match;
          
          while ((match = linkRegex.exec(content)) !== null) {
            const cssFileName = match[1];
            const cssTab = tabs.find(t => t.name === cssFileName && t.language === 'css');
            
            if (cssTab) {
              // Create a style tag with the CSS content
              const styleTag = `<style>/* ${cssFileName} */\n${cssTab.content}\n</style>`;
              
              // Replace the link tag with the style tag in the preview (but not in the actual code)
              const contentForPreview = content.replace(match[0], styleTag);
              
              if (contentForPreview !== content) {
                content = contentForPreview;
                // Reset regex to find other potential link tags
                linkRegex.lastIndex = 0;
              }
            }
          }
          
          doc.open();
          doc.write(content);
          doc.close();
        } else if (tab.language === 'css') {
          for (const htmlTabId in linkedFiles) {
            if (linkedFiles[htmlTabId] === tab.id) {
              const htmlTab = tabs.find(t => t.id === parseInt(htmlTabId));
              if (htmlTab && htmlTab.language === 'html') {
                updatePreview(true); // Recursive call to update as if the HTML tab was active
                break;
              }
            }
          }
        }
      }
      
      function linkCssFile() {
        if (!linkCssContainer || !linkedCssInfo || !linkCssBtn) return;
        
        const currentTab = tabs.find(t => t.id === activeTab);
        if (!currentTab || currentTab.language !== 'html') return;
        
        let isLinked = false;
        let linkedCssTabId = null;
        
        for (const cssTabId in linkedFiles) {
          if (linkedFiles[cssTabId] === currentTab.id) {
            isLinked = true;
            linkedCssTabId = parseInt(cssTabId);
            break;
          }
        }
        
        if (isLinked && linkedCssTabId) {
          // Unlink the CSS file
          const cssTab = tabs.find(t => t.id === linkedCssTabId);
          if (cssTab) {
            // Remove the link tag from HTML content
            const linkRegex = new RegExp(`<link[^>]*href=['"]${cssTab.name}['"][^>]*>`, 'g');
            currentTab.content = currentTab.content.replace(linkRegex, '');
            currentTab.isUnsaved = true;
            
            if (codeEditorInstance && activeTab === currentTab.id) {
              codeEditorInstance.setValue(currentTab.content);
            }
            
            delete linkedFiles[linkedCssTabId];
            updateLinkedCssInfo();
            showToast('CSS file unlinked');
            renderTabs();
          }
        } else {
          const cssFiles = tabs.filter(t => t.language === 'css');
          
          if (cssFiles.length === 0) {
            showToast('No CSS files available. Create a CSS file first.');
            return;
          }
          
          if (cssFiles.length === 1) {
            linkCssToHtml(currentTab, cssFiles[0]);
            return;
          }
          
          const cssFile = prompt('Enter the name of the CSS file to link:', cssFiles[0].name);
          if (!cssFile) return;
          
          const selectedCss = cssFiles.find(t => t.name === cssFile);
          if (selectedCss) {
            linkCssToHtml(currentTab, selectedCss);
          } else {
            showToast(`CSS file '${cssFile}' not found`);
          }
        }
      }
      
      function linkCssToHtml(htmlTab, cssTab) {
        // Check if <head> tag exists
        if (!htmlTab.content.includes('<head>')) {
          showToast('HTML file must have a <head> tag to link CSS');
          return;
        }
        
        // Create link tag
        const linkTag = `<link rel="stylesheet" href="${cssTab.name}">`;
        
        // Add link tag to head with proper indentation
        if (!htmlTab.content.includes(linkTag)) {
          // Detect indentation in the HTML file
          const headMatch = htmlTab.content.match(/(\s*)<head>/);
          const indent = headMatch && headMatch[1] ? headMatch[1] + '  ' : '    ';
          
          htmlTab.content = htmlTab.content.replace('<head>', `<head>\n${indent}${linkTag}`);
          htmlTab.isUnsaved = true;
          
          if (codeEditorInstance && activeTab === htmlTab.id) {
            codeEditorInstance.setValue(htmlTab.content);
          }
        }
        
        linkedFiles[cssTab.id] = htmlTab.id;
        updateLinkedCssInfo();
        showToast(`Linked to ${cssTab.name}`);
        updatePreview(true);
        renderTabs();
      }
      
      function updateLinkedCssInfo() {
        if (!linkedCssInfo) return;
        
        const currentTab = tabs.find(t => t.id === activeTab);
        if (!currentTab || currentTab.language !== 'html') return;
        
        let linkedCssName = null;
        
        for (const cssTabId in linkedFiles) {
          if (linkedFiles[cssTabId] === currentTab.id) {
            const cssTab = tabs.find(t => t.id === parseInt(cssTabId));
            if (cssTab) {
              linkedCssName = cssTab.name;
              break;
            }
          }
        }
        
        if (linkedCssName) {
          linkedCssInfo.textContent = `Linked to: ${linkedCssName}`;
          linkedCssInfo.classList.remove('hidden');
          linkCssBtn.textContent = 'Unlink CSS';
        } else {
          linkedCssInfo.classList.add('hidden');
          linkCssBtn.textContent = 'Link CSS File';
        }
      }
      
      function renameFile(tabId) {
        const tab = tabs.find(t => t.id === tabId);
        if (!tab) return;
        
        const oldName = tab.name;
        const oldExtension = oldName.includes('.') ? oldName.substring(oldName.lastIndexOf('.')) : '';
        
        // Suggest the name without extension for better user experience
        const nameWithoutExt = oldName.includes('.') ? oldName.substring(0, oldName.lastIndexOf('.')) : oldName;
        let newName = prompt('Enter new file name:', nameWithoutExt);
        
        if (!newName || newName === nameWithoutExt) return;
        
        // Make sure extension is preserved
        if (oldExtension && !newName.endsWith(oldExtension)) {
          newName += oldExtension;
        }
        
        tab.name = newName;
        tab.displayName = newName;
        tab.isUnsaved = true;
        
        // If this is a CSS file, update any HTML files that link to it
        if (tab.language === 'css') {
          tabs.forEach(htmlTab => {
            if (htmlTab.language === 'html' && htmlTab.content.includes(`href="${oldName}"`)) {
              // Update the link tag in the HTML content
              const regex = new RegExp(`<link[^>]*href=["']${oldName}["'][^>]*>`, 'g');
              const newLinkTag = `<link rel="stylesheet" href="${newName}">`;
              
              if (regex.test(htmlTab.content)) {
                htmlTab.content = htmlTab.content.replace(regex, newLinkTag);
                htmlTab.isUnsaved = true;
                
                if (codeEditorInstance && activeTab === htmlTab.id) {
                  codeEditorInstance.setValue(htmlTab.content);
                }
              }
            }
          });
        }
        
        renderTabs();
        showToast(`Renamed to ${newName}`);
      }
      
      function closeTab(id) {
        const index = tabs.findIndex(t => t.id === id);
        if (index === -1) return;
        
        const tab = tabs[index];
        
        if (tab.isUnsaved) {
          const confirm = window.confirm(`${tab.name} has unsaved changes. Do you want to close it anyway?`);
          if (!confirm) return;
        }
        
        // Handle unlinking if it's a CSS file
        if (tab.language === 'css') {
          for (const htmlTabId in linkedFiles) {
            if (linkedFiles[htmlTabId] === tab.id) {
              delete linkedFiles[htmlTabId];
            }
          }
        }
        
        // If it's an HTML file with linked CSS
        if (tab.language === 'html') {
          for (const cssTabId in linkedFiles) {
            if (linkedFiles[cssTabId] === tab.id) {
              delete linkedFiles[cssTabId];
            }
          }
        }
        
        tabs.splice(index, 1);
        
        if (tabs.length === 0) {
          activeTab = null;
          if (codeEditorInstance) codeEditorInstance.setValue('');
        } else if (activeTab === id) {
          setActiveTab(tabs[Math.min(index, tabs.length - 1)].id);
        }
        
        renderTabs();
        
        if (tab.language === 'html' && linkCssContainer) {
          linkCssContainer.classList.add('hidden');
        }
      }
      
      async function openFile() {
        try {
          if (!('showOpenFilePicker' in window)) {
            showToast('File system access is not supported in this browser');
            return;
          }
          
          const options = {
            types: [
              {
                description: 'Text Files',
                accept: {
                  'text/*': ['.js', '.py', '.html', '.css', '.txt', '.json', '.rs', '.go']
                }
              }
            ],
            multiple: false
          };
          
          const [fileHandle] = await window.showOpenFilePicker(options);
          const file = await fileHandle.getFile();
          const contents = await file.text();
          
          const fileName = file.name;
          const extension = fileName.substring(fileName.lastIndexOf('.'));
          let language = 'javascript';
          
          for (const lang of languages) {
            if (lang.extensions.includes(extension)) {
              language = lang.id;
              break;
            }
          }
          
          const id = Date.now();
          const tab = {
            id: id,
            name: file.name,
            displayName: file.name,
            language: language,
            content: contents,
            isUnsaved: false,
            fileHandle: fileHandle
          };
          
          tabs.push(tab);
          renderTabs();
          setActiveTab(id);
          
          showToast(`Opened ${file.name}`);
        } catch (err) {
          if (err.name !== 'AbortError') {
            showToast(`Error opening file: ${err.message}`);
            console.error('Error opening file:', err);
          }
        }
      }
      
      async function saveFile() {
        const tab = tabs.find(t => t.id === activeTab);
        if (!tab) return;
        
        try {
          let fileHandle = tab.fileHandle;
          
          if (!fileHandle) {
            if (!('showSaveFilePicker' in window)) {
              showToast('File system access is not supported in this browser');
              downloadFile(tab);
              return;
            }
            
            const options = {
              suggestedName: tab.name,
              types: [
                {
                  description: 'Text File',
                  accept: { 'text/plain': [getFileExtensionForLanguage(tab.language)] }
                }
              ]
            };
            
            fileHandle = await window.showSaveFilePicker(options);
            tab.fileHandle = fileHandle;
            tab.name = fileHandle.name;
            tab.displayName = fileHandle.name;
          }
          
          const writable = await fileHandle.createWritable();
          await writable.write(tab.content);
          await writable.close();
          
          tab.isUnsaved = false;
        renderTabs();
        
          showToast(`Saved ${tab.name}`);
        } catch (err) {
          if (err.name !== 'AbortError') {
            showToast(`Error saving file: ${err.message}`);
            console.error('Error saving file:', err);
          }
        }
      }
      
      async function openFolder() {
        try {
          if (!('showDirectoryPicker' in window)) {
            showToast('Directory access is not supported in this browser');
            return;
          }
          
          const dirHandle = await window.showDirectoryPicker();
          
          const dirName = dirHandle.name;
          showToast(`Opened folder: ${dirName}`);
          
        } catch (err) {
          if (err.name !== 'AbortError') {
            showToast(`Error opening folder: ${err.message}`);
            console.error('Error opening folder:', err);
          }
        }
      }
      
      function downloadFile(tab) {
        if (!tab) {
          tab = tabs.find(t => t.id === activeTab);
          if (!tab) return;
        }
        
        const blob = new Blob([tab.content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = tab.name;
        a.click();
        
        URL.revokeObjectURL(url);
        showToast(`Downloaded ${tab.name}`);
      }
      
      function downloadProject() {
        if (tabs.length === 0) {
          showToast('No files to download');
          return;
        }
        
        const zip = new JSZip();
        
        tabs.forEach(tab => {
          zip.file(tab.name, tab.content);
        });
        
        zip.generateAsync({ type: 'blob' }).then(blob => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'code-crystal-project.zip';
          a.click();
          
          URL.revokeObjectURL(url);
          showToast('Project downloaded as zip');
        }).catch(err => {
          showToast(`Error creating zip: ${err.message}`);
          console.error('Error creating zip:', err);
        });
      }
      
      function loadSettingsToForm() {
        const accentColorPicker = document.getElementById('accent-color-picker');
        const fontSizeSlider = document.getElementById('font-size-slider');
        const fontSizeValue = document.getElementById('font-size-value');
        const lineWrapCheckbox = document.getElementById('line-wrap-checkbox');
        const lineNumbersCheckbox = document.getElementById('line-numbers-checkbox');
        
        document.querySelectorAll('.theme-option').forEach(btn => {
          if (btn.dataset.theme === userSettings.theme) {
            btn.classList.add('ring-2', 'ring-blue-500');
          } else {
            btn.classList.remove('ring-2', 'ring-blue-500');
          }
        });
        
        if (accentColorPicker) {
          accentColorPicker.value = userSettings.accentColor;
        }
        
        if (fontSizeSlider && fontSizeValue) {
          fontSizeSlider.value = userSettings.fontSize;
          fontSizeValue.textContent = `${userSettings.fontSize}px`;
        }
        
        document.querySelectorAll('.tab-size-btn').forEach(btn => {
          if (parseInt(btn.dataset.size) === userSettings.tabSize) {
            btn.classList.add('bg-blue-600');
          } else {
            btn.classList.remove('bg-blue-600');
          }
        });
        
        if (lineWrapCheckbox) {
          lineWrapCheckbox.checked = userSettings.lineWrap;
        }
        
        if (lineNumbersCheckbox) {
          lineNumbersCheckbox.checked = userSettings.lineNumbers;
        }
        
        document.querySelectorAll('.syntax-color-picker').forEach(picker => {
          const element = picker.dataset.element;
          if (userSettings.syntaxColors[element]) {
            picker.value = userSettings.syntaxColors[element];
          }
        });
      }
      
      function saveSettingsFromForm() {
        const accentColorPicker = document.getElementById('accent-color-picker');
        const fontSizeSlider = document.getElementById('font-size-slider');
        const lineWrapCheckbox = document.getElementById('line-wrap-checkbox');
        const lineNumbersCheckbox = document.getElementById('line-numbers-checkbox');
        
        let selectedTheme = userSettings.theme;
        document.querySelectorAll('.theme-option').forEach(btn => {
          if (btn.classList.contains('ring-2')) {
            selectedTheme = btn.dataset.theme;
          }
        });
        
        let selectedTabSize = userSettings.tabSize;
        document.querySelectorAll('.tab-size-btn').forEach(btn => {
          if (btn.classList.contains('bg-blue-600')) {
            selectedTabSize = parseInt(btn.dataset.size);
          }
        });
        
        userSettings.theme = selectedTheme;
        userSettings.accentColor = accentColorPicker ? accentColorPicker.value : userSettings.accentColor;
        userSettings.fontSize = fontSizeSlider ? parseInt(fontSizeSlider.value) : userSettings.fontSize;
        userSettings.tabSize = selectedTabSize;
        userSettings.lineWrap = lineWrapCheckbox ? lineWrapCheckbox.checked : userSettings.lineWrap;
        userSettings.lineNumbers = lineNumbersCheckbox ? lineNumbersCheckbox.checked : userSettings.lineNumbers;
        
        document.querySelectorAll('.syntax-color-picker').forEach(picker => {
          const element = picker.dataset.element;
          userSettings.syntaxColors[element] = picker.value;
        });
        
        saveSettings();
      }
      
      function applySettings() {
        if (!codeEditorInstance) return;
        
        codeEditorInstance.setOption('lineWrapping', userSettings.lineWrap);
        codeEditorInstance.setOption('lineNumbers', userSettings.lineNumbers);
        codeEditorInstance.setOption('tabSize', userSettings.tabSize);
        codeEditorInstance.setOption('indentUnit', userSettings.tabSize);
        
        document.querySelector('.CodeMirror').style.fontSize = `${userSettings.fontSize}px`;
        
        let themeClass = 'dark';
        switch(userSettings.theme) {
          case 'light':
            themeClass = 'cm-s-default';
            document.body.classList.remove('bg-gray-900');
            document.body.classList.add('bg-gray-100');
            document.querySelectorAll('.bg-gray-800').forEach(el => {
              el.classList.remove('bg-gray-800');
              el.classList.add('bg-gray-200');
            });
            document.querySelectorAll('.text-gray-200').forEach(el => {
              el.classList.remove('text-gray-200');
              el.classList.add('text-gray-800');
            });
            break;
          case 'cosmic':
            themeClass = 'cm-s-dracula';
            document.body.classList.remove('bg-gray-100');
            document.body.classList.add('bg-gray-900');
            document.querySelectorAll('.bg-gray-200').forEach(el => {
              el.classList.remove('bg-gray-200');
              el.classList.add('bg-gray-800');
            });
            document.querySelectorAll('.text-gray-800').forEach(el => {
              el.classList.remove('text-gray-800');
              el.classList.add('text-gray-200');
            });
            break;
          case 'ocean':
            themeClass = 'cm-s-dracula';
            document.body.classList.remove('bg-gray-100');
            document.body.classList.add('bg-gray-900');
            document.querySelectorAll('.bg-gray-200').forEach(el => {
              el.classList.remove('bg-gray-200');
              el.classList.add('bg-gray-800');
            });
            document.querySelectorAll('.text-gray-800').forEach(el => {
              el.classList.remove('text-gray-800');
              el.classList.add('text-gray-200');
            });
            break;
          default:
            themeClass = 'cm-s-dracula';
            document.body.classList.remove('bg-gray-100');
            document.body.classList.add('bg-gray-900');
            document.querySelectorAll('.bg-gray-200').forEach(el => {
              el.classList.remove('bg-gray-200');
              el.classList.add('bg-gray-800');
            });
            document.querySelectorAll('.text-gray-800').forEach(el => {
              el.classList.remove('text-gray-800');
              el.classList.add('text-gray-200');
            });
        }
        
        codeEditorInstance.setOption('theme', themeClass === 'cm-s-dracula' ? 'dracula' : 'default');
        
        const styleSheet = document.createElement('style');
        styleSheet.id = 'syntax-colors-style';
        
        const existingStyle = document.getElementById('syntax-colors-style');
        if (existingStyle) {
          existingStyle.remove();
        }
        
        let css = `
          .cm-keyword {
            color: ${userSettings.syntaxColors.keyword} !important;
            text-shadow: 0 0 8px ${addAlpha(userSettings.syntaxColors.keyword, 0.6)} !important;
            font-weight: bold !important;
          }
          
          .cm-def, .cm-variable-2, .cm-property {
            color: ${userSettings.syntaxColors.def} !important;
            text-shadow: 0 0 8px ${addAlpha(userSettings.syntaxColors.def, 0.6)} !important;
          }
          
          .cm-string {
            color: ${userSettings.syntaxColors.string} !important;
            text-shadow: 0 0 8px ${addAlpha(userSettings.syntaxColors.string, 0.6)} !important;
          }
          
          .cm-number {
            color: ${userSettings.syntaxColors.number} !important;
            text-shadow: 0 0 8px ${addAlpha(userSettings.syntaxColors.number, 0.6)} !important;
          }
          
          .cm-comment {
            color: ${userSettings.syntaxColors.comment} !important;
            font-style: italic !important;
          }
          
          .cm-variable {
            color: ${userSettings.syntaxColors.variable} !important;
            text-shadow: 0 0 8px ${addAlpha(userSettings.syntaxColors.variable, 0.6)} !important;
          }
          
          .keyword-example { color: ${userSettings.syntaxColors.keyword}; }
          .string-example { color: ${userSettings.syntaxColors.string}; }
          .variable-example { color: ${userSettings.syntaxColors.variable}; }
          .number-example { color: ${userSettings.syntaxColors.number}; }
          .comment-example { color: ${userSettings.syntaxColors.comment}; }
          .function-example { color: ${userSettings.syntaxColors.def}; }
        `;
        
        styleSheet.innerText = css;
        document.head.appendChild(styleSheet);
        
        document.querySelectorAll('button.bg-blue-600').forEach(el => {
          el.style.backgroundColor = userSettings.accentColor;
        });
      }
      
      function addAlpha(color, opacity) {
        if (color.startsWith('#')) {
          const r = parseInt(color.slice(1, 3), 16);
          const g = parseInt(color.slice(3, 5), 16);
          const b = parseInt(color.slice(5, 7), 16);
          return `rgba(${r}, ${g}, ${b}, ${opacity})`;
        }
        return color;
      }
      
      function saveSettings() {
        try {
          localStorage.setItem('codecrystal-settings', JSON.stringify(userSettings));
          setCookie('codecrystal-settings', userSettings, 365);
        } catch (e) {
          console.error('Error saving settings:', e);
        }
      }
      
      function setCookie(name, value, days) {
        const d = new Date();
        d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
        const expires = "expires=" + d.toUTCString();
        document.cookie = name + "=" + JSON.stringify(value) + ";" + expires + ";path=/";
      }
      
      function getCookie(name) {
        const cookieName = name + "=";
        const decodedCookie = decodeURIComponent(document.cookie);
        const cookieArray = decodedCookie.split(';');
        
        for (let i = 0; i < cookieArray.length; i++) {
          let cookie = cookieArray[i];
          while (cookie.charAt(0) === ' ') {
            cookie = cookie.substring(1);
          }
          if (cookie.indexOf(cookieName) === 0) {
            try {
              return JSON.parse(cookie.substring(cookieName.length, cookie.length));
            } catch (e) {
              return null;
            }
          }
        }
        return null;
      }
    });
  </script>
</body>
</html>
