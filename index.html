<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CodeCrystal IDE</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Code Mirror for syntax highlighting -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
  
  <!-- Code Mirror language modes -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/ruby/ruby.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/go/go.min.js"></script>
  
  <!-- Code Mirror theme -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">
  
  <!-- Pyodide for Python execution -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
  
  <!-- JSZip Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  
  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%238b5cf6%22><path d=%22M16 18l6-6-6-6M8 6l-6 6 6 6%22/></svg>">
  
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
    
    /* Custom glow effects for CodeMirror tokens */
    .cm-keyword {
      color: #ff9d00 !important;
      text-shadow: 0 0 8px rgba(255, 157, 0, 0.6) !important;
      font-weight: bold !important;
    }
    
    .cm-def, .cm-variable-2, .cm-property {
      color: #c792ea !important;
      text-shadow: 0 0 8px rgba(199, 146, 234, 0.6) !important;
    }
    
    .cm-string {
      color: #7ec699 !important;
      text-shadow: 0 0 8px rgba(126, 198, 153, 0.6) !important;
    }
    
    .cm-number {
      color: #7fcef5 !important;
      text-shadow: 0 0 8px rgba(127, 206, 245, 0.6) !important;
    }
    
    .cm-comment {
      color: #676e95 !important;
      font-style: italic !important;
    }
    
    .cm-variable {
      color: #e06c75 !important;
      text-shadow: 0 0 8px rgba(224, 108, 117, 0.6) !important;
    }
    
    .cm-operator {
      color: #f9f9f9 !important;
      text-shadow: 0 0 8px rgba(249, 249, 249, 0.6) !important;
    }
    
    .cm-tag {
      color: #ff5370 !important;
      text-shadow: 0 0 8px rgba(255, 83, 112, 0.6) !important;
    }
    
    .cm-attribute {
      color: #ffcb6b !important;
      text-shadow: 0 0 8px rgba(255, 203, 107, 0.6) !important;
    }
    
    /* Overriding CodeMirror styles */
    .CodeMirror {
      height: 100% !important;
      font-family: monospace !important;
      font-size: 14px !important;
      line-height: 1.6 !important;
    }
    
    .CodeMirror-gutters {
      background-color: rgba(0, 0, 0, 0.3) !important;
      border-right: none !important;
    }
    
    .CodeMirror-linenumber {
      color: #909090 !important;
    }
    
    /* Terminal styles */
    .terminal {
      background-color: #1a1a1a;
      color: #f0f0f0;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      padding: 10px;
      overflow-y: auto;
      white-space: pre-wrap;
      height: 100%;
    }
    
    .terminal-error {
      color: #ff6b6b;
    }
    
    .terminal-success {
      color: #6bff6b;
    }
    
    .terminal-warning {
      color: #ffde6b;
    }
    
    .terminal-line {
      margin: 0;
      padding: 2px 0;
    }
    
    /* File badge */
    .file-badge {
      width: 12px;
      height: 12px;
      border-radius: 6px;
      display: inline-block;
      margin-right: 8px;
    }
    
    /* Unsaved indicator */
    .unsaved-indicator {
      width: 8px;
      height: 8px;
      border-radius: 4px;
      background-color: #f87171;
      display: inline-block;
      margin-left: 6px;
    }
    
    /* Toast notification style */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 20px;
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      border-radius: 4px;
      z-index: 1000;
      transition: opacity 0.5s ease;
    }
    
    /* Language badges - make them more rounded */
    .language-badge {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 4px 12px;
      border-radius: 16px;
      margin-right: 8px;
      cursor: pointer;
      font-size: 0.875rem;
      min-width: 80px;
      text-align: center;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .language-badge:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }
    
    /* File tab styling */
    .tab {
      display: flex;
      align-items: center;
      padding: 8px 16px;
      padding-right: 8px;
      cursor: pointer;
      border-right: 1px solid #2d3748;
      position: relative;
      overflow: hidden;
      min-width: 120px;
      max-width: 200px;
    }
    
    .tab.active {
      background-color: #2d3748;
    }
    
    .tab-name-container {
      flex-grow: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .tab-actions {
      display: flex;
      margin-left: 4px;
      opacity: 0.7;
    }
    
    .tab:hover .tab-actions {
      opacity: 1;
    }
    
    .tab-action-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      border-radius: 4px;
      margin-left: 2px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
    }
    
    .tab-action-btn:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    /* Sidebar button styling */
    .sidebar-button {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
      border-radius: 8px;
      color: #cccccc;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .sidebar-button:hover {
      background-color: rgba(255, 255, 255, 0.1);
      transform: translateY(-1px);
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-200">
  <div id="editor-container" class="flex flex-col h-screen">
    <!-- Header -->
    <div class="flex items-center justify-between p-2 border-b border-gray-700">
      <div class="flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-2 text-purple-500" viewBox="0 0 24 24" fill="none" 
           stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="16 18 22 12 16 6"></polyline>
          <polyline points="8 6 2 12 8 18"></polyline>
        </svg>
        <span class="font-bold text-lg">CodeCrystal IDE</span>
        <span id="file-counter" class="text-xs ml-4 text-gray-400">No files open</span>
      </div>
      <div class="flex space-x-3">
        <div class="relative group">
          <button id="new-file-btn" class="p-1 rounded hover:bg-gray-700" title="New File (Ctrl+N)">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-400" viewBox="0 0 24 24" fill="none" 
               stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="12" y1="18" x2="12" y2="12"></line>
              <line x1="9" y1="15" x2="15" y2="15"></line>
            </svg>
          </button>
          <div id="new-file-dropdown" class="absolute hidden bg-gray-800 border border-gray-700 rounded shadow-lg p-2 z-10 right-0 mt-1">
            <div class="text-xs font-bold mb-1 text-gray-400">New file as:</div>
            <div id="language-options"></div>
          </div>
        </div>
        <button id="open-file-btn" class="p-1 rounded hover:bg-gray-700" title="Open File (Ctrl+O)">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-400" viewBox="0 0 24 24" fill="none" 
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M5 8V5a2 2 0 0 1 2-2h7.5L19 7.5V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8Z"></path>
            <path d="M12 18v-6"></path>
            <path d="m9 15 3-3 3 3"></path>
          </svg>
        </button>
        <button id="save-file-btn" class="p-1 rounded hover:bg-gray-700" title="Save File (Ctrl+S)">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-400" viewBox="0 0 24 24" fill="none" 
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
            <polyline points="17 21 17 13 7 13 7 21"></polyline>
            <polyline points="7 3 7 8 15 8"></polyline>
          </svg>
        </button>
        <!-- Settings Button -->
        <button id="settings-btn" class="p-1 rounded hover:bg-gray-700" title="Settings">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-400" viewBox="0 0 24 24" fill="none" 
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>
        </button>
      </div>
    </div>
    
    <!-- Main Content -->
    <div class="flex flex-1 overflow-hidden">
      <!-- Sidebar -->
      <div class="w-16 bg-gray-800 flex flex-col items-center py-4 border-r border-gray-700">
        <button id="open-folder-btn" class="sidebar-button" title="Open Folder">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-blue-400" viewBox="0 0 24 24" fill="none" 
               stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"></path>
          </svg>
        </button>
        <button id="rename-file-btn" class="sidebar-button" title="Rename Current File">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-green-400" viewBox="0 0 24 24" fill="none" 
               stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 20h9"></path>
            <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
          </svg>
        </button>
        <button id="preview-toggle-btn" class="sidebar-button" title="Toggle Preview">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-gray-400" viewBox="0 0 24 24" fill="none" 
               stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>
        </button>
        <button id="terminal-toggle-btn" class="sidebar-button" title="Toggle Terminal">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-gray-400" viewBox="0 0 24 24" fill="none" 
               stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="4 17 10 11 4 5"></polyline>
            <line x1="12" y1="19" x2="20" y2="19"></line>
          </svg>
        </button>
        <button id="run-code-sidebar-btn" class="sidebar-button" title="Run Code (F5)">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-green-400" viewBox="0 0 24 24" fill="none" 
               stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="5 3 19 12 5 21 5 3"></polygon>
          </svg>
        </button>
        <button id="download-project-btn" class="sidebar-button" title="Download Project">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-purple-400" viewBox="0 0 24 24" fill="none" 
               stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
        </button>
      </div>
      
      <!-- Editor Area -->
      <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Tabs -->
        <div id="tabs-container" class="flex border-b border-gray-700 overflow-x-auto"></div>
        
        <!-- Language Bar -->
        <div id="language-bar" class="flex items-center p-2 bg-gray-800">
          <span class="mr-2 text-sm">Language:</span>
          <div id="language-selector" class="flex space-x-2 overflow-x-auto"></div>
          
          <!-- Link CSS file button (only visible for HTML files) -->
          <div id="link-css-container" class="ml-auto hidden">
            <button id="link-css-btn" class="px-2 py-1 bg-purple-600 text-white rounded text-xs flex items-center">
              Link CSS File
            </button>
            <span id="linked-css-info" class="ml-2 text-xs hidden"></span>
          </div>
        </div>
        
        <!-- Editor and Preview Container -->
        <div id="editor-preview-container" class="flex-1 flex overflow-hidden">
          <!-- Code Editor -->
          <div id="editor-area" class="relative w-full">
            <div id="code-editor"></div>
          </div>
          
          <!-- Preview panel (hidden by default) -->
          <div id="preview-panel" class="hidden w-1/2 border-l border-gray-700 flex flex-col">
            <div class="p-2 bg-gray-800 flex justify-between items-center">
              <span class="text-sm font-medium">Live Preview</span>
              <button id="refresh-preview-btn" class="px-2 py-1 bg-green-600 text-white rounded text-xs">
                Refresh
              </button>
            </div>
            <div class="flex-1 bg-white overflow-auto">
              <iframe id="preview-iframe" style="width: 100%; height: 100%; border: none;" title="Preview"></iframe>
            </div>
          </div>
          
          <!-- Terminal panel (hidden by default) -->
          <div id="terminal-panel" class="hidden w-1/2 border-l border-gray-700 flex flex-col">
            <div class="p-2 bg-gray-800 flex justify-between items-center">
              <span class="text-sm font-medium">Terminal</span>
              <div class="flex space-x-2">
                <button id="clear-terminal-btn" class="px-2 py-1 bg-gray-600 text-white rounded text-xs">
                  Clear
                </button>
                <button id="run-code-btn" class="px-2 py-1 bg-green-600 text-white rounded text-xs flex items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" 
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1">
                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                  </svg>
                  Run
                </button>
              </div>
            </div>
            <div id="terminal" class="terminal flex-1 overflow-auto">
              <div class="terminal-line">Welcome to CodeCrystal Terminal. Press Run to execute your code.</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Status Bar -->
    <div class="flex justify-between items-center px-4 py-1 text-sm bg-gray-800 text-gray-400">
      <div>
        <span id="cursor-position" class="mr-4">Line: 1, Col: 1</span>
        <span>Spaces: 2</span>
      </div>
      <div>
        <span id="language-indicator" class="px-2 py-1 rounded"></span>
      </div>
    </div>
  </div>
  
  <!-- Toast Container -->
  <div id="toast" class="toast hidden"></div>
  
  <!-- Add Settings Modal HTML before the Toast Container -->
  <!-- Settings Modal -->
  <div id="settings-modal" class="fixed inset-0 flex items-center justify-center hidden z-50">
    <div class="fixed inset-0 bg-black opacity-50" id="settings-backdrop"></div>
    <div class="bg-gray-800 rounded-lg shadow-lg w-11/12 md:w-3/4 lg:w-1/2 max-h-[80vh] overflow-y-auto relative z-10">
      <div class="flex justify-between items-center p-4 border-b border-gray-700">
        <h2 class="text-xl font-bold">CodeCrystal Settings</h2>
        <button id="close-settings-btn" class="text-gray-400 hover:text-white">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      
      <div class="p-4">
        <!-- Settings Tabs -->
        <div class="flex border-b border-gray-700 mb-4">
          <button class="settings-tab-btn px-4 py-2 text-blue-400 border-b-2 border-blue-400" data-tab="theme">Theme</button>
          <button class="settings-tab-btn px-4 py-2 text-gray-400" data-tab="editor">Editor</button>
          <button class="settings-tab-btn px-4 py-2 text-gray-400" data-tab="colors">Syntax Colors</button>
        </div>
        
        <!-- Theme Settings -->
        <div class="settings-tab-content" id="theme-settings">
          <div class="mb-4">
            <h3 class="text-lg font-medium mb-2">Editor Theme</h3>
            <div class="flex space-x-2">
              <button class="theme-option px-4 py-2 rounded bg-gray-700 text-white" data-theme="dark">Dark</button>
              <button class="theme-option px-4 py-2 rounded bg-gray-400 text-gray-800" data-theme="light">Light</button>
              <button class="theme-option px-4 py-2 rounded bg-purple-900 text-white" data-theme="cosmic">Cosmic</button>
              <button class="theme-option px-4 py-2 rounded bg-blue-900 text-white" data-theme="ocean">Ocean</button>
            </div>
          </div>
          
          <div class="mb-4">
            <h3 class="text-lg font-medium mb-2">Accent Color</h3>
            <div class="flex items-center space-x-3">
              <input type="color" id="accent-color-picker" value="#8b5cf6" class="w-12 h-12 rounded cursor-pointer">
              <span class="text-sm text-gray-400">This color will be used for UI highlights</span>
            </div>
          </div>
        </div>
        
        <!-- Editor Settings -->
        <div class="settings-tab-content hidden" id="editor-settings">
          <div class="mb-4">
            <h3 class="text-lg font-medium mb-2">Font Size</h3>
            <div class="flex items-center">
              <input type="range" id="font-size-slider" min="10" max="24" value="14" class="w-full mr-3">
              <span id="font-size-value" class="text-gray-300 w-10">14px</span>
            </div>
          </div>
          
          <div class="mb-4">
            <h3 class="text-lg font-medium mb-2">Tab Size</h3>
            <div class="flex space-x-2">
              <button class="tab-size-btn px-3 py-1 rounded bg-gray-700" data-size="2">2 spaces</button>
              <button class="tab-size-btn px-3 py-1 rounded bg-gray-700" data-size="4">4 spaces</button>
            </div>
          </div>
          
          <div class="mb-4">
            <h3 class="text-lg font-medium mb-2">Other Options</h3>
            <div class="space-y-2">
              <label class="flex items-center">
                <input type="checkbox" id="line-wrap-checkbox" class="mr-2">
                <span>Enable line wrapping</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" id="line-numbers-checkbox" checked class="mr-2">
                <span>Show line numbers</span>
              </label>
            </div>
          </div>
        </div>
        
        <!-- Syntax Colors Settings -->
        <div class="settings-tab-content hidden" id="colors-settings">
          <div class="mb-4">
            <h3 class="text-lg font-medium mb-2">Syntax Highlighting</h3>
            <p class="text-sm text-gray-400 mb-4">Customize the syntax highlighting colors for all languages</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="syntax-color-item">
                <div class="flex justify-between items-center mb-1">
                  <label>Keywords</label>
                  <input type="color" class="syntax-color-picker" data-element="keyword" value="#ff9d00">
                </div>
                <div class="p-2 rounded bg-gray-900">
                  <code class="keyword-example">function</code> <code>return</code> <code>if</code>
                </div>
              </div>
              
              <div class="syntax-color-item">
                <div class="flex justify-between items-center mb-1">
                  <label>Strings</label>
                  <input type="color" class="syntax-color-picker" data-element="string" value="#7ec699">
                </div>
                <div class="p-2 rounded bg-gray-900">
                  <code class="string-example">"Hello, world!"</code>
                </div>
              </div>
              
              <div class="syntax-color-item">
                <div class="flex justify-between items-center mb-1">
                  <label>Variables</label>
                  <input type="color" class="syntax-color-picker" data-element="variable" value="#e06c75">
                </div>
                <div class="p-2 rounded bg-gray-900">
                  <code class="variable-example">myVariable</code>
                </div>
              </div>
              
              <div class="syntax-color-item">
                <div class="flex justify-between items-center mb-1">
                  <label>Numbers</label>
                  <input type="color" class="syntax-color-picker" data-element="number" value="#7fcef5">
                </div>
                <div class="p-2 rounded bg-gray-900">
                  <code class="number-example">42</code> <code>3.14</code>
                </div>
              </div>
              
              <div class="syntax-color-item">
                <div class="flex justify-between items-center mb-1">
                  <label>Comments</label>
                  <input type="color" class="syntax-color-picker" data-element="comment" value="#676e95">
                </div>
                <div class="p-2 rounded bg-gray-900">
                  <code class="comment-example">// This is a comment</code>
                </div>
              </div>
              
              <div class="syntax-color-item">
                <div class="flex justify-between items-center mb-1">
                  <label>Functions</label>
                  <input type="color" class="syntax-color-picker" data-element="def" value="#c792ea">
                </div>
                <div class="p-2 rounded bg-gray-900">
                  <code class="function-example">myFunction()</code>
                </div>
              </div>
            </div>
            
            <div class="mt-4">
              <button id="reset-colors-btn" class="px-3 py-1 bg-red-600 text-white rounded">Reset to Defaults</button>
            </div>
          </div>
        </div>
      </div>
      
      <div class="flex justify-end p-4 border-t border-gray-700">
        <button id="save-settings-btn" class="px-4 py-2 bg-blue-600 text-white rounded">Save Settings</button>
      </div>
    </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Main data and state
      let tabs = [];
      let activeTab = null;
      let showPreview = false;
      let showTerminal = false;
      let theme = 'dark';
      let linkedFiles = {};
      let pyodideInstance = null;
      let pyodideLoading = false;
      let codeEditorInstance = null;
      
      // Add user settings object
      let userSettings = {
        theme: 'dark',
        accentColor: '#8b5cf6',
        fontSize: 14,
        tabSize: 2,
        lineWrap: false,
        lineNumbers: true,
        syntaxColors: {
          keyword: '#ff9d00',
          string: '#7ec699',
          variable: '#e06c75',
          number: '#7fcef5',
          comment: '#676e95',
          def: '#c792ea'
        }
      };
      
      // Language definitions
      const languages = [
        { id: 'javascript', name: 'JavaScript', color: '#f7df1e', extensions: ['.js', '.jsx', '.ts', '.tsx'], mime: 'text/javascript' },
        { id: 'python', name: 'Python', color: '#3572A5', extensions: ['.py'], mime: 'text/x-python' },
        { id: 'rust', name: 'Rust', color: '#dea584', extensions: ['.rs'], mime: 'text/x-rustsrc' },
        { id: 'go', name: 'Go', color: '#00ADD8', extensions: ['.go'], mime: 'text/x-go' },
        { id: 'html', name: 'HTML', color: '#e34c26', extensions: ['.html', '.htm'], mime: 'text/html' },
        { id: 'css', name: 'CSS', color: '#563d7c', extensions: ['.css'], mime: 'text/css' }
      ];
      
      // DOM elements - with null checks
      const tabsContainer = document.getElementById('tabs-container');
      const languageSelector = document.getElementById('language-selector');
      const previewPanel = document.getElementById('preview-panel');
      const previewIframe = document.getElementById('preview-iframe');
      const previewToggleBtn = document.getElementById('preview-toggle-btn');
      const terminalPanel = document.getElementById('terminal-panel');
      const terminal = document.getElementById('terminal');
      const terminalToggleBtn = document.getElementById('terminal-toggle-btn');
      const runCodeBtn = document.getElementById('run-code-btn');
      const runCodeSidebarBtn = document.getElementById('run-code-sidebar-btn');
      const clearTerminalBtn = document.getElementById('clear-terminal-btn');
      const linkCssContainer = document.getElementById('link-css-container');
      const linkedCssInfo = document.getElementById('linked-css-info');
      const linkCssBtn = document.getElementById('link-css-btn');
      const cursorPosition = document.getElementById('cursor-position');
      const languageIndicator = document.getElementById('language-indicator');
      const fileCounter = document.getElementById('file-counter');
      const toast = document.getElementById('toast');
      const newFileBtn = document.getElementById('new-file-btn');
      const newFileDropdown = document.getElementById('new-file-dropdown');
      const languageOptions = document.getElementById('language-options');
      const openFileBtn = document.getElementById('open-file-btn');
      const saveFileBtn = document.getElementById('save-file-btn');
      const openFolderBtn = document.getElementById('open-folder-btn');
      const renameFileBtn = document.getElementById('rename-file-btn');
      const downloadProjectBtn = document.getElementById('download-project-btn');
      const refreshPreviewBtn = document.getElementById('refresh-preview-btn');
      const themeToggleBtn = document.getElementById('theme-toggle-btn');
      const editorArea = document.getElementById('editor-area');
      
      // Setup function declarations for browser reference
      window.writeToTerminalFromPython = function(text) {
        writeToTerminal(text);
      };
      
      // Show toast notification
      function showToast(message) {
        if (!toast) return;
        
        toast.textContent = message;
        toast.classList.remove('hidden');
        
        // Auto-hide after 3 seconds
        setTimeout(() => {
          toast.classList.add('hidden');
        }, 3000);
      }
      
      // Get file extension for language
      function getFileExtensionForLanguage(language) {
        switch(language) {
          case 'javascript': return '.js';
          case 'python': return '.py';
          case 'rust': return '.rs';
          case 'go': return '.go';
          case 'html': return '.html';
          case 'css': return '.css';
          default: return '.txt';
        }
      }
      
      // Get template for language
      function getTemplateForLanguage(language) {
        switch(language) {
          case 'html':
            return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  
</body>
</html>`;
          case 'css':
            return `/* Styles for your document */
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 20px;
}
`;
          case 'javascript':
            return `// JavaScript code
console.log('Hello, world!');

function init() {
  // Your initialization code here
}
`;
          case 'python':
            return `# Python script

def main():
    # Print a simple greeting
    print("Hello, world!")
    
    # Some basic Python examples
    numbers = [1, 2, 3, 4, 5]
    squared = [n**2 for n in numbers]
    print(f"Original numbers: {numbers}")
    print(f"Squared numbers: {squared}")
    
    # String operations
    message = "Python in the browser!"
    print(f"Message: {message}")
    print(f"Uppercase: {message.upper()}")
    print(f"Character count: {len(message)}")

# Call the main function
main()
`;
          case 'rust':
            return `// Rust program

fn main() {
    println!("Hello, world!");
}
`;
          case 'go':
            return `// Go program
package main

import "fmt"

func main() {
    fmt.Println("Hello, world!")
}
`;
          default:
            return '// Start typing your code here...';
        }
      }
      
      // Get language color
      function getLanguageColor(language) {
        return languages.find(l => l.id === language)?.color || '#ffffff';
      }
      
      // Handle editor input
      function handleEditorInput() {
        const tab = tabs.find(t => t.id === activeTab);
        if (!tab) return;
        
        tab.content = codeEditorInstance.getValue();
        tab.isUnsaved = true;
        renderTabs();
        
        // Update preview if showing
        if (showPreview && (tab.language === 'html' || tab.language === 'css')) {
          updatePreview();
        }
      }
      
      // Render tabs
      function renderTabs() {
        if (!tabsContainer) return;
        
        tabsContainer.innerHTML = '';
        
        tabs.forEach(tab => {
          const tabElement = document.createElement('div');
          tabElement.className = `tab ${tab.id === activeTab ? 'active' : ''}`;
          
          // Color badge
          const badge = document.createElement('div');
          badge.className = 'file-badge';
          badge.style.backgroundColor = getLanguageColor(tab.language);
          tabElement.appendChild(badge);
          
          // File name container
          const nameContainer = document.createElement('div');
          nameContainer.className = 'tab-name-container';
          nameContainer.title = tab.path ? `${tab.path}/${tab.name}` : tab.name;
          
          if (tab.path) {
            const pathSpan = document.createElement('span');
            pathSpan.className = 'text-xs text-gray-500 mr-1';
            pathSpan.textContent = tab.path + '/';
            nameContainer.appendChild(pathSpan);
          }
          
          const nameSpan = document.createElement('span');
          nameSpan.textContent = tab.displayName || tab.name;
          nameContainer.appendChild(nameSpan);
          
          // Unsaved indicator
          if (tab.isUnsaved) {
            const unsavedDot = document.createElement('div');
            unsavedDot.className = 'unsaved-indicator ml-2';
            nameContainer.appendChild(unsavedDot);
          }
          
          tabElement.appendChild(nameContainer);
          
          // Action buttons
          const actions = document.createElement('div');
          actions.className = 'tab-actions';
          
          // Rename button
          const renameBtn = document.createElement('button');
          renameBtn.className = 'tab-action-btn';
          renameBtn.innerHTML = '✎';
          renameBtn.title = 'Rename';
          renameBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            renameFile(tab.id);
          });
          
          // Close button
          const closeBtn = document.createElement('button');
          closeBtn.className = 'tab-action-btn';
          closeBtn.innerHTML = '×';
          closeBtn.title = 'Close';
          closeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            closeTab(tab.id);
          });
          
          actions.appendChild(renameBtn);
          actions.appendChild(closeBtn);
          tabElement.appendChild(actions);
          
          // Tab click handler
          tabElement.addEventListener('click', () => setActiveTab(tab.id));
          
          tabsContainer.appendChild(tabElement);
        });
        
        // Update file counter
        if (fileCounter) {
          fileCounter.textContent = tabs.length > 0 ? `${tabs.length} files open` : 'No files open';
        }
      }
      
      // Set active tab
      function setActiveTab(id) {
        const tab = tabs.find(t => t.id === id);
        if (!tab) return;
        
        activeTab = id;
        
        // Update CodeMirror with the content and language mode
        if (codeEditorInstance) {
          codeEditorInstance.setValue(tab.content);
          
          // Set appropriate language mode
          const langInfo = languages.find(l => l.id === tab.language);
          if (langInfo) {
            codeEditorInstance.setOption('mode', langInfo.mime);
          }
        }
        
        updateLanguageUI(tab.language);
        renderTabs();
        
        // Show/hide CSS link button
        if (tab.language === 'html' && linkCssContainer) {
          linkCssContainer.classList.remove('hidden');
          updateLinkedCssInfo();
        } else if (linkCssContainer) {
          linkCssContainer.classList.add('hidden');
        }
        
        // Update preview if needed
        if (showPreview && (tab.language === 'html' || tab.language === 'css')) {
          updatePreview(true);
        } else if (showPreview && previewPanel && editorArea) {
          previewPanel.classList.add('hidden');
          editorArea.classList.remove('w-1/2');
          editorArea.classList.add('w-full');
        }
      }
      
      // Update language UI
      function updateLanguageUI(language) {
        if (!languageSelector || !languageIndicator) return;
        
        // Update language selector
        const allBadges = languageSelector.querySelectorAll('.language-badge');
        allBadges.forEach(badge => {
          if (badge.dataset.language === language) {
            badge.style.boxShadow = `0 0 8px ${getLanguageColor(language)}`;
            badge.style.fontWeight = 'bold';
          } else {
            badge.style.boxShadow = 'none';
            badge.style.fontWeight = 'normal';
          }
        });
        
        // Update status bar
        const color = getLanguageColor(language);
        languageIndicator.style.backgroundColor = color;
        languageIndicator.style.color = 'black';
        languageIndicator.style.boxShadow = `0 0 5px ${color}`;
        languageIndicator.textContent = languages.find(l => l.id === language)?.name || 'Unknown';
      }
      
      // Create a new tab
      function createNewTab(language) {
        const id = Date.now();
        const extension = getFileExtensionForLanguage(language);
        const content = getTemplateForLanguage(language);
        
        const tab = {
          id: id,
          name: `untitled${extension}`,
          displayName: `untitled${extension}`,
          language: language,
          content: content,
          isUnsaved: true,
          fileHandle: null
        };
        
        tabs.push(tab);
        renderTabs();
        setActiveTab(id);
        showToast(`Created new ${languages.find(l => l.id === language).name} file`);
      }
      
      // Initialize the editor
      initEditor();
      
      function initEditor() {
        if (!languageSelector) {
          console.error("Language selector not found");
          return;
        }
        
        // Initialize CodeMirror
        codeEditorInstance = CodeMirror(document.getElementById('code-editor'), {
          lineNumbers: true,
          theme: 'dracula',
          mode: 'javascript',
          indentUnit: 2,
          tabSize: 2,
          lineWrapping: false,
          autoCloseBrackets: true,
          matchBrackets: true,
          styleActiveLine: true,
          extraKeys: {
            "Tab": function(cm) {
              cm.replaceSelection("  ", "end");
            }
          }
        });
        
        // Set height
        codeEditorInstance.setSize("100%", "100%");
        
        // Add cursor position listener
        codeEditorInstance.on("cursorActivity", function() {
          const cursor = codeEditorInstance.getCursor();
          if (cursorPosition) {
            cursorPosition.textContent = `Line: ${cursor.line + 1}, Col: ${cursor.ch + 1}`;
          }
        });
        
        // Add change listener
        codeEditorInstance.on("change", function() {
          handleEditorInput();
        });
        
        // Populate language options
        languages.forEach(lang => {
          // For language selector
          const langBtn = document.createElement('div');
          langBtn.className = 'language-badge';
          langBtn.style.backgroundColor = lang.color;
          langBtn.style.color = 'black';
          langBtn.textContent = lang.name;
          langBtn.dataset.language = lang.id;
          languageSelector.appendChild(langBtn);
          
          if (languageOptions) {
            // For new file dropdown
            const option = document.createElement('div');
            option.className = 'px-3 py-1 hover:bg-gray-700 cursor-pointer rounded text-sm flex items-center';
            option.dataset.language = lang.id;
            
            const colorDot = document.createElement('div');
            colorDot.className = 'w-2 h-2 rounded-full mr-2';
            colorDot.style.backgroundColor = lang.color;
            
            option.appendChild(colorDot);
            option.appendChild(document.createTextNode(lang.name));
            languageOptions.appendChild(option);
          }
        });
        
        // Load user settings before creating tabs
        loadSettings();
        
        // Create a default tab
        createNewTab('javascript');
        
        // Set up event listeners
        setupEventListeners();
      }
      
      // Toggle new file dropdown menu
      function toggleNewFileDropdown() {
        if (!newFileDropdown) return;
        
        if (newFileDropdown.classList.contains('hidden')) {
          newFileDropdown.classList.remove('hidden');
        } else {
          newFileDropdown.classList.add('hidden');
        }
      }
      
      function setupEventListeners() {
        // Button events - with null checks
        if (newFileBtn) newFileBtn.addEventListener('click', toggleNewFileDropdown);
        if (openFileBtn) openFileBtn.addEventListener('click', openFile);
        if (saveFileBtn) saveFileBtn.addEventListener('click', saveFile);
        if (openFolderBtn) openFolderBtn.addEventListener('click', openFolder);
        if (renameFileBtn) renameFileBtn.addEventListener('click', () => renameFile(activeTab));
        if (downloadProjectBtn) downloadProjectBtn.addEventListener('click', downloadProject);
        if (refreshPreviewBtn) refreshPreviewBtn.addEventListener('click', () => updatePreview(true));
        if (themeToggleBtn) themeToggleBtn.addEventListener('click', toggleTheme);
        if (previewToggleBtn) previewToggleBtn.addEventListener('click', togglePreview);
        if (terminalToggleBtn) terminalToggleBtn.addEventListener('click', toggleTerminal);
        if (linkCssBtn) linkCssBtn.addEventListener('click', linkCssFile);
        if (runCodeBtn) runCodeBtn.addEventListener('click', runCode);
        if (runCodeSidebarBtn) runCodeSidebarBtn.addEventListener('click', runCode);
        if (clearTerminalBtn) clearTerminalBtn.addEventListener('click', clearTerminal);
        
        // Settings related event listeners
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const settingsTabBtns = document.querySelectorAll('.settings-tab-btn');
        const resetColorsBtn = document.getElementById('reset-colors-btn');
        
        // Open settings modal
        if (settingsBtn) {
          settingsBtn.addEventListener('click', function() {
            if (settingsModal) {
              settingsModal.classList.remove('hidden');
              loadSettingsToForm();
            }
          });
        }
        
        // Close settings modal
        if (closeSettingsBtn) {
          closeSettingsBtn.addEventListener('click', function() {
            if (settingsModal) settingsModal.classList.add('hidden');
          });
        }
        
        // Close settings when clicking backdrop
        if (settingsModal) {
          const settingsBackdrop = document.getElementById('settings-backdrop');
          if (settingsBackdrop) {
            settingsBackdrop.addEventListener('click', function() {
              settingsModal.classList.add('hidden');
            });
          }
        }
        
        // Settings tabs navigation
        if (settingsTabBtns) {
          settingsTabBtns.forEach(btn => {
            btn.addEventListener('click', function() {
              const tabName = btn.dataset.tab;
              
              // Update active tab button
              settingsTabBtns.forEach(b => {
                b.classList.remove('text-blue-400', 'border-b-2', 'border-blue-400');
                b.classList.add('text-gray-400');
              });
              btn.classList.remove('text-gray-400');
              btn.classList.add('text-blue-400', 'border-b-2', 'border-blue-400');
              
              // Show selected tab content
              document.querySelectorAll('.settings-tab-content').forEach(content => {
                content.classList.add('hidden');
              });
              document.getElementById(`${tabName}-settings`).classList.remove('hidden');
            });
          });
        }
        
        // Theme options
        document.querySelectorAll('.theme-option').forEach(btn => {
          btn.addEventListener('click', function() {
            document.querySelectorAll('.theme-option').forEach(b => {
              b.classList.remove('ring-2', 'ring-blue-500');
            });
            btn.classList.add('ring-2', 'ring-blue-500');
          });
        });
        
        // Font size slider
        const fontSizeSlider = document.getElementById('font-size-slider');
        const fontSizeValue = document.getElementById('font-size-value');
        if (fontSizeSlider && fontSizeValue) {
          fontSizeSlider.addEventListener('input', function() {
            fontSizeValue.textContent = `${fontSizeSlider.value}px`;
          });
        }
        
        // Tab size buttons
        document.querySelectorAll('.tab-size-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            document.querySelectorAll('.tab-size-btn').forEach(b => {
              b.classList.remove('bg-blue-600');
            });
            btn.classList.add('bg-blue-600');
          });
        });
        
        // Reset colors button
        if (resetColorsBtn) {
          resetColorsBtn.addEventListener('click', function() {
            const defaultColors = {
              keyword: '#ff9d00',
              string: '#7ec699',
              variable: '#e06c75',
              number: '#7fcef5',
              comment: '#676e95',
              def: '#c792ea'
            };
            
            document.querySelectorAll('.syntax-color-picker').forEach(picker => {
              const element = picker.dataset.element;
              if (defaultColors[element]) {
                picker.value = defaultColors[element];
              }
            });
          });
        }
        
        // Save settings button
        if (saveSettingsBtn) {
          saveSettingsBtn.addEventListener('click', function() {
            saveSettingsFromForm();
            applySettings();
            if (settingsModal) settingsModal.classList.add('hidden');
            showToast('Settings saved successfully');
          });
        }
        
        // Language selector
        if (languageSelector) {
          languageSelector.addEventListener('click', function(e) {
            const langBtn = e.target.closest('.language-badge');
            if (langBtn) {
              const language = langBtn.dataset.language;
              if (language) {
                changeLanguage(language);
              }
            }
          });
        }
        
        // New file dropdown
        if (languageOptions) {
          languageOptions.addEventListener('click', function(e) {
            const option = e.target.closest('[data-language]');
            if (option) {
              const language = option.dataset.language;
              if (language) {
                createNewTab(language);
                toggleNewFileDropdown();
              }
            }
          });
        }
        
        // Close dropdown when clicking elsewhere
        document.addEventListener('click', (e) => {
          if (newFileDropdown && !e.target.closest('#new-file-btn') && !e.target.closest('#new-file-dropdown')) {
            newFileDropdown.classList.add('hidden');
          }
        });
        
        // F5 key for running code
        document.addEventListener('keydown', (e) => {
          if (e.key === 'F5') {
            e.preventDefault();
            runCode();
          }
          
          // Ctrl+S for save
          if (e.key === 's' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            saveFile();
          }
          
          // Ctrl+N for new file
          if (e.key === 'n' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            toggleNewFileDropdown();
          }
          
          // Ctrl+O for open file
          if (e.key === 'o' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            openFile();
          }
        });
      }
      
      // Toggle preview panel
      function togglePreview() {
        if (!previewPanel || !editorArea) return;
        
        showPreview = !showPreview;
        
            if (showPreview) {
          previewPanel.classList.remove('hidden');
          editorArea.classList.remove('w-full');
          editorArea.classList.add('w-1/2');
          updatePreview(true);
        } else {
          previewPanel.classList.add('hidden');
          editorArea.classList.remove('w-1/2');
          editorArea.classList.add('w-full');
        }
      }
      
      // Toggle terminal panel
      function toggleTerminal() {
        if (!terminalPanel || !editorArea) return;
        
        showTerminal = !showTerminal;
        
            if (showTerminal) {
          terminalPanel.classList.remove('hidden');
          if (showPreview) {
            // Both panels are visible, adjust sizes
            editorArea.classList.remove('w-1/2', 'w-full');
            editorArea.classList.add('w-1/3');
            previewPanel.classList.remove('w-1/2');
            previewPanel.classList.add('w-1/3');
            terminalPanel.classList.remove('w-1/2');
            terminalPanel.classList.add('w-1/3');
            } else {
            editorArea.classList.remove('w-full');
            editorArea.classList.add('w-1/2');
            terminalPanel.classList.remove('w-1/2');
            terminalPanel.classList.add('w-1/2');
          }
        } else {
          terminalPanel.classList.add('hidden');
          if (showPreview) {
            // Only preview is visible
            editorArea.classList.remove('w-1/3', 'w-full');
            editorArea.classList.add('w-1/2');
            previewPanel.classList.remove('w-1/3');
            previewPanel.classList.add('w-1/2');
          } else {
            // No panels visible
            editorArea.classList.remove('w-1/2', 'w-1/3');
            editorArea.classList.add('w-full');
          }
        }
      }
      
      // Change language of current file
      function changeLanguage(language) {
        const tab = tabs.find(t => t.id === activeTab);
        if (!tab) return;
        
        const oldExtension = tab.name.substring(tab.name.lastIndexOf('.'));
        const newExtension = getFileExtensionForLanguage(language);
        
        // If the file has a name (is not untitled), replace extension
        if (tab.name.lastIndexOf('.') !== -1) {
          tab.name = tab.name.substring(0, tab.name.lastIndexOf('.')) + newExtension;
          tab.displayName = tab.name;
        }
        
        // Check if content is empty or just a basic comment before changing language
        const currentContent = tab.content;
        let updatedContent = currentContent;
        
        const isBasicComment = 
          currentContent.trim() === '// Start typing your code here...' ||
          currentContent.trim() === '# Start typing your code here...';
          
        if (!currentContent.trim() || isBasicComment) {
          updatedContent = getTemplateForLanguage(language);
        }
        
        tab.language = language;
        tab.content = updatedContent;
        tab.isUnsaved = true;
        
        // Update CodeMirror with potentially new content
        if (codeEditorInstance) {
          codeEditorInstance.setValue(updatedContent);
          
          // Set appropriate language mode
          const langInfo = languages.find(l => l.id === language);
          if (langInfo) {
            codeEditorInstance.setOption('mode', langInfo.mime);
          }
        }
        
        updateLanguageUI(language);
        renderTabs();
        
        // Show/hide CSS link button
        if (tab.language === 'html' && linkCssContainer) {
          linkCssContainer.classList.remove('hidden');
          updateLinkedCssInfo();
        } else if (linkCssContainer) {
          linkCssContainer.classList.add('hidden');
        }
      }
      
      // Write to terminal
      function writeToTerminal(text, className = '') {
        if (!terminal) return;
        
        const line = document.createElement('div');
        line.className = `terminal-line ${className}`;
        line.textContent = text;
        terminal.appendChild(line);
        
        // Auto-scroll to bottom
        terminal.scrollTop = terminal.scrollHeight;
      }
      
      // Clear terminal
      function clearTerminal() {
        if (!terminal) return;
        
        terminal.innerHTML = '';
        writeToTerminal('Terminal cleared');
      }
      
      // Run code
      async function runCode() {
        const tab = tabs.find(t => t.id === activeTab);
        if (!tab) return;
        
        // Show terminal if not visible
        if (!showTerminal && terminalPanel) {
          toggleTerminal();
        }
        
        // Clear terminal before running
        clearTerminal();
        
        writeToTerminal(`Running ${tab.name}...`, 'terminal-success');
        
        if (tab.language === 'javascript') {
          try {
            // Create a sandbox function to run the code
            const code = tab.content;
            const consoleMethods = {
              log: (...args) => writeToTerminal(args.join(' ')),
              warn: (...args) => writeToTerminal(args.join(' '), 'terminal-warning'),
              error: (...args) => writeToTerminal(args.join(' '), 'terminal-error'),
              info: (...args) => writeToTerminal(args.join(' '))
            };
            
            // Create a function that will run with a modified console
            const runWithCustomConsole = new Function('console', code);
            
            // Execute the code with the custom console
            runWithCustomConsole(consoleMethods);
            
            writeToTerminal('Code executed successfully', 'terminal-success');
        } catch (error) {
            writeToTerminal(`Error: ${error.message}`, 'terminal-error');
          }
        } else if (tab.language === 'python') {
          // Run Python code using Pyodide
          await runPythonCode(tab.content);
        } else {
          writeToTerminal(`Language '${tab.language}' execution is not supported in the browser.`, 'terminal-warning');
        }
      }
      
      // Run Python code using Pyodide
      async function runPythonCode(code) {
        // Show loading in terminal
        writeToTerminal('Initializing Python environment...', 'terminal-warning');
        
        try {
          // Load Pyodide if not already loaded
        if (!pyodideInstance) {
            if (pyodideLoading) {
              writeToTerminal('Python environment is still loading, please wait...', 'terminal-warning');
          return;
        }
            
            pyodideLoading = true;
            writeToTerminal('Loading Python (this may take a moment on first run)...', 'terminal-warning');
        
        try {
              pyodideInstance = await loadPyodide();
              writeToTerminal('Python environment loaded successfully!', 'terminal-success');
          
              // Add custom print function that writes to terminal
              await pyodideInstance.runPythonAsync(`
            import sys
                from js import writeToTerminalFromPython
                
                class CustomStdout:
                def write(self, text):
                        writeToTerminalFromPython(text)
                def flush(self):
                        pass
                
                sys.stdout = CustomStdout()
                sys.stderr = CustomStdout()
              `);
              
            } catch (err) {
              writeToTerminal(`Failed to load Python: ${err.message}`, 'terminal-error');
              pyodideLoading = false;
              return;
            }
            
            pyodideLoading = false;
          }
          
          // Execute Python code
          writeToTerminal('Running Python code...', 'terminal-success');
          await pyodideInstance.runPythonAsync(code);
          writeToTerminal('Python execution completed', 'terminal-success');
          
        } catch (err) {
          writeToTerminal(`Python Error: ${err.message}`, 'terminal-error');
        }
      }
      
      // Update preview
      function updatePreview(force = false) {
        if (!showPreview && !force) return;
        if (!previewPanel || !previewIframe) return;
        
        const tab = tabs.find(t => t.id === activeTab);
        if (!tab) return;
        
        // If it's an HTML file, show it directly
        if (tab.language === 'html') {
          const doc = previewIframe.contentDocument || previewIframe.contentWindow.document;
          let content = tab.content;
          
          // Check for linked CSS files and inject them
          for (const tabId in linkedFiles) {
            if (linkedFiles[tabId] === tab.id) {
              const cssTab = tabs.find(t => t.id === parseInt(tabId));
              if (cssTab && cssTab.language === 'css') {
                // Inject the CSS content into the HTML
                content = content.replace('</head>', `<style>${cssTab.content}</style></head>`);
              }
            }
          }
          
          doc.open();
          doc.write(content);
          doc.close();
        } else if (tab.language === 'css') {
          // For CSS files, find any HTML files that link to this CSS and update them
          for (const htmlTabId in linkedFiles) {
            if (linkedFiles[htmlTabId] === tab.id) {
              const htmlTab = tabs.find(t => t.id === parseInt(htmlTabId));
              if (htmlTab && htmlTab.language === 'html') {
                const doc = previewIframe.contentDocument || previewIframe.contentWindow.document;
                let content = htmlTab.content;
                
                // Inject the CSS content into the HTML
                content = content.replace('</head>', `<style>${tab.content}</style></head>`);
                
                doc.open();
                doc.write(content);
                doc.close();
                break;
              }
            }
          }
        }
      }
      
      // Update linked CSS info
      function updateLinkedCssInfo() {
        if (!linkCssContainer || !linkedCssInfo || !linkCssBtn) return;
        
        const currentTab = tabs.find(t => t.id === activeTab);
        if (!currentTab || currentTab.language !== 'html') return;
        
        // Check if this HTML file has a linked CSS file
        let isLinked = false;
        let linkedCssName = '';
        
        for (const cssTabId in linkedFiles) {
          if (linkedFiles[cssTabId] === currentTab.id) {
            isLinked = true;
            const cssTab = tabs.find(t => t.id === parseInt(cssTabId));
              if (cssTab) {
              linkedCssName = cssTab.name;
            }
            break;
          }
        }
        
        if (isLinked) {
          linkedCssInfo.textContent = `Linked to: ${linkedCssName}`;
          linkedCssInfo.classList.remove('hidden');
          linkCssBtn.textContent = 'Unlink CSS';
              } else {
          linkedCssInfo.classList.add('hidden');
          linkCssBtn.textContent = 'Link CSS';
        }
      }
      
      // Link/unlink CSS file
      function linkCssFile() {
        const htmlTab = tabs.find(t => t.id === activeTab);
        if (!htmlTab || htmlTab.language !== 'html') return;
        
        // Check if already linked
        let isLinked = false;
        let linkedCssTabId = null;
        
        for (const cssTabId in linkedFiles) {
          if (linkedFiles[cssTabId] === htmlTab.id) {
            isLinked = true;
            linkedCssTabId = parseInt(cssTabId);
                break;
              }
            }
        
        if (isLinked && linkedCssTabId) {
          // Unlink the CSS file
          delete linkedFiles[linkedCssTabId];
          updateLinkedCssInfo();
          showToast('CSS file unlinked');
        } else {
          // Show available CSS files to link
          const cssFiles = tabs.filter(t => t.language === 'css');
          
          if (cssFiles.length === 0) {
            showToast('No CSS files available. Create a CSS file first.');
            return;
          }
          
          // If only one CSS file, link it directly
          if (cssFiles.length === 1) {
            linkedFiles[cssFiles[0].id] = htmlTab.id;
            updateLinkedCssInfo();
            showToast(`Linked to ${cssFiles[0].name}`);
            updatePreview(true);
            return;
          }
          
          // If multiple CSS files, prompt user to choose
          const cssFile = prompt('Enter the name of the CSS file to link:', cssFiles[0].name);
          if (!cssFile) return;
          
          const selectedCss = cssFiles.find(t => t.name === cssFile);
          if (selectedCss) {
            linkedFiles[selectedCss.id] = htmlTab.id;
            updateLinkedCssInfo();
            showToast(`Linked to ${selectedCss.name}`);
            updatePreview(true);
              } else {
            showToast(`CSS file '${cssFile}' not found`);
          }
        }
      }
      
      // Open file (local file system API)
      async function openFile() {
        try {
          // Check if File System API is supported
          if (!('showOpenFilePicker' in window)) {
            showToast('File system access is not supported in this browser');
            return;
          }
          
          const options = {
            types: [
              {
                description: 'Text Files',
                accept: {
                  'text/*': ['.js', '.py', '.html', '.css', '.txt', '.json', '.rs', '.go']
                }
              }
            ],
            multiple: false
          };
          
          const [fileHandle] = await window.showOpenFilePicker(options);
          const file = await fileHandle.getFile();
          const contents = await file.text();
          
          // Determine language from file extension
          const fileName = file.name;
          const extension = fileName.substring(fileName.lastIndexOf('.'));
          let language = 'javascript'; // Default
          
          for (const lang of languages) {
            if (lang.extensions.includes(extension)) {
              language = lang.id;
              break;
            }
          }
          
          // Create a new tab with the file contents
        const id = Date.now();
        const tab = {
          id: id,
            name: file.name,
            displayName: file.name,
          language: language,
            content: contents,
            isUnsaved: false,
            fileHandle: fileHandle
        };
        
        tabs.push(tab);
        renderTabs();
        setActiveTab(id);
          
          showToast(`Opened ${file.name}`);
        } catch (err) {
          // User cancelled or error occurred
          if (err.name !== 'AbortError') {
            showToast(`Error opening file: ${err.message}`);
            console.error('Error opening file:', err);
          }
        }
      }
      
      // Save file (local file system API)
      async function saveFile() {
        const tab = tabs.find(t => t.id === activeTab);
        if (!tab) return;
        
        try {
          let fileHandle = tab.fileHandle;
          
          // If no file handle, show save file picker
          if (!fileHandle) {
            // Check if File System API is supported
            if (!('showSaveFilePicker' in window)) {
              showToast('File system access is not supported in this browser');
              downloadFile(tab); // Fallback to download
              return;
            }
            
            const options = {
              suggestedName: tab.name,
              types: [
                {
                  description: 'Text File',
                  accept: { 'text/plain': [getFileExtensionForLanguage(tab.language)] }
                }
              ]
            };
            
            fileHandle = await window.showSaveFilePicker(options);
            tab.fileHandle = fileHandle;
            tab.name = fileHandle.name;
            tab.displayName = fileHandle.name;
          }
          
          // Get writable stream and write content
          const writable = await fileHandle.createWritable();
          await writable.write(tab.content);
          await writable.close();
          
          tab.isUnsaved = false;
        renderTabs();
        
          showToast(`Saved ${tab.name}`);
        } catch (err) {
          // User cancelled or error occurred
          if (err.name !== 'AbortError') {
            showToast(`Error saving file: ${err.message}`);
            console.error('Error saving file:', err);
          }
        }
      }
      
      // Open folder (local file system API)
      async function openFolder() {
        try {
          // Check if File System API is supported
          if (!('showDirectoryPicker' in window)) {
            showToast('Directory access is not supported in this browser');
            return;
          }
          
          const dirHandle = await window.showDirectoryPicker();
          
          // Store the directory handle for later use
          const dirName = dirHandle.name;
          showToast(`Opened folder: ${dirName}`);
          
          // You could list files in the directory here if needed
        } catch (err) {
          // User cancelled or error occurred
          if (err.name !== 'AbortError') {
            showToast(`Error opening folder: ${err.message}`);
            console.error('Error opening folder:', err);
          }
        }
      }
      
      // Download current file
      function downloadFile(tab) {
        if (!tab) {
          tab = tabs.find(t => t.id === activeTab);
          if (!tab) return;
        }
        
        const blob = new Blob([tab.content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = tab.name;
        a.click();
        
        URL.revokeObjectURL(url);
        showToast(`Downloaded ${tab.name}`);
      }
      
      // Download project as zip
      function downloadProject() {
        if (tabs.length === 0) {
          showToast('No files to download');
          return;
        }
        
        // Create a new JSZip instance
        const zip = new JSZip();
        
        // Add each tab to the zip
        tabs.forEach(tab => {
          zip.file(tab.name, tab.content);
        });
        
        // Generate the zip file
        zip.generateAsync({ type: 'blob' }).then(blob => {
          // Create a download link
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'code-crystal-project.zip';
          a.click();
          
          URL.revokeObjectURL(url);
          showToast('Project downloaded as zip');
        }).catch(err => {
          showToast(`Error creating zip: ${err.message}`);
          console.error('Error creating zip:', err);
        });
      }
      
      // Load settings from form controls
      function loadSettingsToForm() {
        const accentColorPicker = document.getElementById('accent-color-picker');
        const fontSizeSlider = document.getElementById('font-size-slider');
        const fontSizeValue = document.getElementById('font-size-value');
        const lineWrapCheckbox = document.getElementById('line-wrap-checkbox');
        const lineNumbersCheckbox = document.getElementById('line-numbers-checkbox');
        
        // Set theme option
        document.querySelectorAll('.theme-option').forEach(btn => {
          if (btn.dataset.theme === userSettings.theme) {
            btn.classList.add('ring-2', 'ring-blue-500');
          } else {
            btn.classList.remove('ring-2', 'ring-blue-500');
          }
        });
        
        // Set accent color
        if (accentColorPicker) {
          accentColorPicker.value = userSettings.accentColor;
        }
        
        // Set font size
        if (fontSizeSlider && fontSizeValue) {
          fontSizeSlider.value = userSettings.fontSize;
          fontSizeValue.textContent = `${userSettings.fontSize}px`;
        }
        
        // Set tab size
        document.querySelectorAll('.tab-size-btn').forEach(btn => {
          if (parseInt(btn.dataset.size) === userSettings.tabSize) {
            btn.classList.add('bg-blue-600');
          } else {
            btn.classList.remove('bg-blue-600');
          }
        });
        
        // Set other options
        if (lineWrapCheckbox) {
          lineWrapCheckbox.checked = userSettings.lineWrap;
        }
        
        if (lineNumbersCheckbox) {
          lineNumbersCheckbox.checked = userSettings.lineNumbers;
        }
        
        // Set syntax colors
        document.querySelectorAll('.syntax-color-picker').forEach(picker => {
          const element = picker.dataset.element;
          if (userSettings.syntaxColors[element]) {
            picker.value = userSettings.syntaxColors[element];
          }
        });
      }
      
      // Save settings from form to userSettings object
      function saveSettingsFromForm() {
        const accentColorPicker = document.getElementById('accent-color-picker');
        const fontSizeSlider = document.getElementById('font-size-slider');
        const lineWrapCheckbox = document.getElementById('line-wrap-checkbox');
        const lineNumbersCheckbox = document.getElementById('line-numbers-checkbox');
        
        // Get selected theme
        let selectedTheme = userSettings.theme;
        document.querySelectorAll('.theme-option').forEach(btn => {
          if (btn.classList.contains('ring-2')) {
            selectedTheme = btn.dataset.theme;
          }
        });
        
        // Get selected tab size
        let selectedTabSize = userSettings.tabSize;
        document.querySelectorAll('.tab-size-btn').forEach(btn => {
          if (btn.classList.contains('bg-blue-600')) {
            selectedTabSize = parseInt(btn.dataset.size);
          }
        });
        
        // Update settings object
        userSettings.theme = selectedTheme;
        userSettings.accentColor = accentColorPicker ? accentColorPicker.value : userSettings.accentColor;
        userSettings.fontSize = fontSizeSlider ? parseInt(fontSizeSlider.value) : userSettings.fontSize;
        userSettings.tabSize = selectedTabSize;
        userSettings.lineWrap = lineWrapCheckbox ? lineWrapCheckbox.checked : userSettings.lineWrap;
        userSettings.lineNumbers = lineNumbersCheckbox ? lineNumbersCheckbox.checked : userSettings.lineNumbers;
        
        // Update syntax colors
        document.querySelectorAll('.syntax-color-picker').forEach(picker => {
          const element = picker.dataset.element;
          userSettings.syntaxColors[element] = picker.value;
        });
        
        // Save to localStorage and cookies
        saveSettings();
      }
      
      // Apply settings to the editor and UI
      function applySettings() {
        // Apply theme
        theme = userSettings.theme;
        applyTheme();
        
        // Apply font size to CodeMirror
        if (codeEditorInstance) {
          const cm = codeEditorInstance.getWrapperElement();
          if (cm) {
            cm.style.fontSize = `${userSettings.fontSize}px`;
          }
        }
        
        // Apply tab size
        if (codeEditorInstance) {
          codeEditorInstance.setOption('tabSize', userSettings.tabSize);
          codeEditorInstance.setOption('indentUnit', userSettings.tabSize);
        }
        
        // Apply line wrapping
        if (codeEditorInstance) {
          codeEditorInstance.setOption('lineWrapping', userSettings.lineWrap);
        }
        
        // Apply line numbers
        if (codeEditorInstance) {
          codeEditorInstance.setOption('lineNumbers', userSettings.lineNumbers);
        }
        
        // Apply syntax colors
        applySyntaxColors();
      }
      
      // Apply theme to the UI
      function applyTheme() {
        const container = document.getElementById('editor-container');
        
        // Remove any previous theme styles
        const oldThemeStyles = document.querySelectorAll('style[data-theme]');
        oldThemeStyles.forEach(style => style.remove());
        
        // Reset container classes
        container.classList.remove('bg-gray-900', 'text-gray-200', 'bg-gray-100', 'text-gray-800');
        
        // Apply selected theme
        switch (theme) {
          case 'dark':
            container.classList.add('bg-gray-900', 'text-gray-200');
            if (codeEditorInstance) {
              codeEditorInstance.setOption('theme', 'dracula');
            }
            break;
          case 'light':
            container.classList.add('bg-gray-100', 'text-gray-800');
            if (codeEditorInstance) {
              codeEditorInstance.setOption('theme', 'default');
              
              // Add custom styles for light theme
              const light = document.createElement('style');
              light.setAttribute('data-theme', 'light');
              light.innerHTML = `
                body.bg-gray-100 { background-color: #e0e0e0 !important; }
                .CodeMirror { background-color: #e0e0e0 !important; color: #333 !important; }
                .CodeMirror-gutters { background-color: #d0d0d0 !important; border-right: 1px solid #bbb !important; }
                .bg-gray-800 { background-color: #c8c8c8 !important; }
                .bg-gray-700 { background-color: #bbb !important; }
                .border-gray-700 { border-color: #aaa !important; }
                .text-gray-400 { color: #444 !important; }
                .text-gray-200 { color: #333 !important; }
                .tab.active { background-color: #bbb !important; }
                .terminal { background-color: #d5d5d5 !important; color: #333 !important; }
                .sidebar-button { color: #444 !important; }
                .sidebar-button:hover { background-color: rgba(0, 0, 0, 0.1) !important; }
                .hover\\:bg-gray-700:hover { background-color: #aaa !important; }
                .p-1.rounded svg { color: #444 !important; }
                .settings-tab-btn { color: #444 !important; }
                .settings-tab-btn.text-blue-400 { color: #3b82f6 !important; }
                #editor-container { background-color: #e0e0e0 !important; }
                #editor-area { background-color: #e0e0e0 !important; }
                #code-editor { background-color: #e0e0e0 !important; }
                .CodeMirror-scroll { background-color: #e0e0e0 !important; }
                .CodeMirror-sizer { background-color: #e0e0e0 !important; }
                .CodeMirror-gutter { background-color: #d0d0d0 !important; }
                .CodeMirror-lines { background-color: #e0e0e0 !important; }
                .CodeMirror pre.CodeMirror-line { background-color: #e0e0e0 !important; }
                .CodeMirror-line { background-color: #e0e0e0 !important; }
                .CodeMirror div, .CodeMirror span, .CodeMirror pre { background-color: #e0e0e0 !important; }
                .CodeMirror-cursor { border-left-color: #000 !important; }
                .cm-s-default { background-color: #e0e0e0 !important; }
              `;
              document.head.appendChild(light);
            }
            break;
          case 'cosmic':
            container.classList.add('bg-gray-900', 'text-gray-200');
            if (codeEditorInstance) {
              codeEditorInstance.setOption('theme', 'dracula');
              
              // Add custom styles for cosmic theme
              const cosmic = document.createElement('style');
              cosmic.setAttribute('data-theme', 'cosmic');
              cosmic.innerHTML = `
                .CodeMirror.cm-s-dracula { background-color: #1a1040 !important; }
                .CodeMirror-gutters { background-color: #150b30 !important; }
                .bg-gray-800 { background-color: #20165a !important; }
                .bg-gray-700 { background-color: #2a1b78 !important; }
                .border-gray-700 { border-color: #2a1b78 !important; }
              `;
              document.head.appendChild(cosmic);
            }
            break;
          case 'ocean':
            container.classList.add('bg-gray-900', 'text-gray-200');
            if (codeEditorInstance) {
              codeEditorInstance.setOption('theme', 'dracula');
              
              // Add custom styles for ocean theme
              const ocean = document.createElement('style');
              ocean.setAttribute('data-theme', 'ocean');
              ocean.innerHTML = `
                .CodeMirror.cm-s-dracula { background-color: #0a2a40 !important; }
                .CodeMirror-gutters { background-color: #061825 !important; }
                .bg-gray-800 { background-color: #0d3b5c !important; }
                .bg-gray-700 { background-color: #124979 !important; }
                .border-gray-700 { border-color: #124979 !important; }
              `;
              document.head.appendChild(ocean);
            }
            break;
        }
      }
      
      // Apply syntax colors
      function applySyntaxColors() {
        // Create or update custom CSS for syntax highlighting
        let styleEl = document.getElementById('custom-syntax-colors');
        if (!styleEl) {
          styleEl = document.createElement('style');
          styleEl.id = 'custom-syntax-colors';
          document.head.appendChild(styleEl);
        }
        
        // Generate CSS rules
        const css = `
          .cm-keyword {
            color: ${userSettings.syntaxColors.keyword} !important;
            text-shadow: 0 0 8px ${hexToRgba(userSettings.syntaxColors.keyword, 0.6)} !important;
          }
          
          .cm-def, .cm-variable-2, .cm-property {
            color: ${userSettings.syntaxColors.def} !important;
            text-shadow: 0 0 8px ${hexToRgba(userSettings.syntaxColors.def, 0.6)} !important;
          }
          
          .cm-string {
            color: ${userSettings.syntaxColors.string} !important;
            text-shadow: 0 0 8px ${hexToRgba(userSettings.syntaxColors.string, 0.6)} !important;
          }
          
          .cm-number {
            color: ${userSettings.syntaxColors.number} !important;
            text-shadow: 0 0 8px ${hexToRgba(userSettings.syntaxColors.number, 0.6)} !important;
          }
          
          .cm-comment {
            color: ${userSettings.syntaxColors.comment} !important;
          }
          
          .cm-variable {
            color: ${userSettings.syntaxColors.variable} !important;
            text-shadow: 0 0 8px ${hexToRgba(userSettings.syntaxColors.variable, 0.6)} !important;
          }
          
          /* Update example colors in settings */
          .keyword-example { color: ${userSettings.syntaxColors.keyword}; }
          .string-example { color: ${userSettings.syntaxColors.string}; }
          .variable-example { color: ${userSettings.syntaxColors.variable}; }
          .number-example { color: ${userSettings.syntaxColors.number}; }
          .comment-example { color: ${userSettings.syntaxColors.comment}; }
          .function-example { color: ${userSettings.syntaxColors.def}; }
        `;
        
        styleEl.textContent = css;
      }
      
      // Helper function to convert hex color to rgba
      function hexToRgba(hex, alpha) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
      }
      
      // Load settings from localStorage or cookies
      function loadSettings() {
        // Try to load from localStorage first
        let settings = null;
        const savedLocal = localStorage.getItem('codecrystal-settings');
        
        if (savedLocal) {
          try {
            settings = JSON.parse(savedLocal);
          } catch (e) {
            console.error('Error loading settings from localStorage:', e);
          }
        }
        
        // If localStorage failed, try cookies as backup
        if (!settings) {
          const cookieData = getCookie('codecrystal-settings');
          if (cookieData) {
            settings = cookieData;
          }
        }
        
        // Apply the loaded settings if any were found
        if (settings) {
          userSettings = { ...userSettings, ...settings };
        }
        
        applySettings();
      }
      
      // Cookie utility functions
      function setCookie(name, value, days) {
        let expires = "";
        if (days) {
          const date = new Date();
          date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
          expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + encodeURIComponent(JSON.stringify(value)) + expires + "; path=/";
      }
      
      function getCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for (let i = 0; i < ca.length; i++) {
          let c = ca[i];
          while (c.charAt(0) === ' ') c = c.substring(1, c.length);
          if (c.indexOf(nameEQ) === 0) {
            try {
              return JSON.parse(decodeURIComponent(c.substring(nameEQ.length, c.length)));
            } catch (e) {
              console.error('Error parsing cookie value:', e);
              return null;
            }
          }
        }
        return null;
      }
      
      // Save settings to both localStorage and cookies for redundancy
      function saveSettings() {
        // Save to localStorage (primary method)
        localStorage.setItem('codecrystal-settings', JSON.stringify(userSettings));
        
        // Also save to cookies as backup (expires in 30 days)
        setCookie('codecrystal-settings', userSettings, 30);
      }
      
      // Update toggleTheme to work with our settings system
      function toggleTheme() {
        // Just cycle through themes
        const themes = ['dark', 'light', 'cosmic', 'ocean'];
        const currentIndex = themes.indexOf(userSettings.theme);
        const nextIndex = (currentIndex + 1) % themes.length;
        userSettings.theme = themes[nextIndex];
        
        // Apply the theme
        theme = userSettings.theme;
        applyTheme();
        
        // Apply syntax colors (in case theme affects these)
        applySyntaxColors();
        
        // Save settings
        saveSettings();
      }
    });
  </script>
</body>
</html>
